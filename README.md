# spring-daagn-market-18th

CEOS 18th Backend Study - Carrot Market

# 2주차 - DB 모델링과 JPA

당근마켓 DB 모델링을 할 때 아래와 같은 기능을 구현할 수 있도록 참고했다.<br>

- 물건 올리기
- 물건 찾기
- 1:1 채팅
- 구매 확정
- 리뷰(온도)
- 회원 기능

한가지씩 기능에서 어떤 부분을 중점으로 집중해서 설계를 했는지 정리해보겠습니다.<br>
기본적으로 모든 테이블의 공통 컬럼인 생성일(`FRST_REG_DT`)과 수정일(`LAST_CHG_DT`)은 `BaseTimeEntity`로 엔티티를 하나 빼서 자동 등록할 수 있게 설계하였습니다. 참고 부탁드립니다.

### 물건 올리기

물건 올리기 기능은 `물건 팔기` 페이지를 확인하며 필요한 정보들을 테이블에 담았다.<br>
해당 테이블은 `PROD_LIST`이며, 스마트폰을 기준으로 최상단에 이미지가 최대 10개까지 등록할 수 있도록 구현되어 있는데, `PROD_IMG_LIST` 테이블로 분리해서 이미지들을 저장할 수 있게 설계했다.<br>
제목(`PROD_TIT`), 제목을 설정하면 나타나는 키워드(`PROD_KEYW`), 키워드에 따라 선택적으로 등장하는 브랜드(`PROD_BRN`)와 사이즈(`PROD_SIZ`), 거래 방식으로 판매하기와 나눔하기 등 2가지 방법으로 나눌 수 있어(`TRD_CD`)를 Enum 타입으로 설계를 하였고, 각 거래 방식에 따라 박스 하단 가격 제안 받기 혹은 나눔 이벤트 열기 옵션을 선택할 수 있어(`TRD_OPT_CD`), 가격을 설정할 수 있는(`PROD_PRC`), 자세한 설명을 적는 란(`PROD_CONT`), 거래 희망 장소와 보여줄 동네 선택을 마지막에 확인해서 시간이 부족해서 아직 추가하지 못 했습니다.. 제출하고 바로 수정할게요 ㅜㅜ

### 물건 찾기

물건 찾기 기능은 물건 올리기를 설계하며 `PROD_LIST` 테이블에 해당 물건이 현재 팔린 물건인지, 예약되어 있는 물건인지 등을 확인할 수 있는 `TRD_STAT` 컬럼을 추가하며 마무리했습니다.

### 1:1 채팅

채팅 기능은 `CHAT_LIST` 테이블에 정의되어 있습니다.<br>
채팅을 보낸 사람(`SEND_NO`)와 받는 사람(`RECV_NO`)는 유저 테이블 `USR_LIST`의 PK를 FK로 받아와서 설계했고, 채팅창을 고정하는 핀 기능(`CHAT_PIN_YN`), 채팅의 알람 설정 기능(`CHAT_ALM_YN`), 상대 차단 기능(`CHAT_BLK`) 등으로 채팅을 관리하는 역할을 하는 테이블을 구성했습니다.<br>
추가로, 채팅을 주고 받았을 때 메세지를 관리하는 테이블(`CHAT_MSG_LIST`)을 설계했으며, 이는 보낸 사람(`SEND_NO`), 보낸 채팅방(`CHAT_NO`), 메세지 내용(`MSG_CONT`), 보낸 시간 등으로 구성되어 있습니다.

### 구매 확정

구매 확정 기능은 사실 당근 마켓 기준으로, 직접 만나서 거래하는 형식으로 진행되기 때문에 `Order` 테이블을 빼진 않고, `PROD_LIST`의 현재 판매 진행 상태(`TRD_STAT`)를 기준으로 구매가 진행되었는지 확인할 수 있도록 설계했습니다.<br>
추가로, 리뷰를 작성하면 구매자를 알 수 있기 때문에 `REVW_LIST`의 `USR_NO`로 구매자를 확인할 수 있으나, 현재 당근마켓 또한 구매자가 리뷰를 작성하지 않으면 누가 구매했는지 알 수 없는 상태인 것으로 보입니다. 제가 당근마켓을 통해 구매, 판매를 해본 경험이 없어서 더 많은 기능이 있는 건 확인하지 못했습니다..

### 리뷰(온도)

리뷰 기능은 `REVW_LIST` 테이블을 확인하면 알 수 있습니다.<br>
리뷰는 정말 간단하게 진행되는데, 거래가 어땠는지 상태를 총 3가지("별로에요", "좋아요!", "최고에요!")로 표현할 수 있어 이를 Enum 타입으로 `REVW_STAT`로 설계했습니다. 어떤 점이 좋았는지 체크박스 형태로 한 줄? 정도 작성할 수 있기에 `REVW_LINE` 컬럼을 정의했으며, 선택 사항으로 거래했던 경험(`REVW_CONT`)을 작성할 수 있으며 이는 선택사항이기 때문에 NULL도 가능합니다. 거래하는 이미지도 추가할 수 있어, (`REVW_IMG_URL`)을 테이블에 추가했습니다. 이미지 테이블로 옮기지 않은 이유는 1장밖에 첨부할 수 없는데, Join 하는 비용보다 테이블 내에 배치하는 것이 더 비용적으로 아낄 수 있지 않을까.. 라는 개인적인 생각입니다.

### 회원 기능

정말 마지막 회원 기능은 처음 회원가입을 진행해보면서 알 수 있었습니다. 이는 `USR_LIST` 테이블을 확인하면 됩니다.<br>
제일 처음 핸드폰 번호로 로그인을 할 수 있으며(`PH_NM`), 닉네임을 정해서(`NIC_NM`) 회원가입을 할 수 있습니다. 닉네임 같은 경우 12자 이상으로 작성할 수 없기 때문에 `varchar(12)`로 크기를 고정했습니다. 자신이 현재 위치한 곳(`ADR`)과 매너 온도(`MNN_TEMP`)는 36.5도가 기본값이기에 숫자를 점까지 총 4개의 문자를 넣을 수 있도록 크기를 4로 고정했습니다. 주소를 인증했는지(`ADR_CERT_YN`)와, 처음 회원가입을 한 기기는 어떤 것인지(`UA`) -> 이는 나중에 자기는 회원가입을 했던 기억이 없다. 막 이런 컴플레인이 걸렸을 때 해결할 수 있도록 기기값까지 받는다고 하던데 사실 잘 모르겠습니다. 그리고, 개인정보를 동의했는지(`PRI_YN`) 이는 동의를 해야 들어올 수 있기 때문에 default 로 'Y' 값을 주었습니다. 마케팅 수신 동의(`MKTG_YN`)를 마지막으로 모든 테이블의 컬럼을 설명드렸습니다.

### 최종 ERD

<img width="710" alt="스크린샷 2023-09-30 오후 10 03 27" src="https://github.com/Remedi2022/backend/assets/89639470/e3c1a2f3-8996-4cf1-b673-98b84be465bb">

### 놓친 부분

유저가 자신이 원하는 지역을 여러 군데 설정할 수 있으나, 이는 아직 생각을 못 했습니다.

### 설계하며 고려했던 사항들

기본적으로 개인 취향에 따라 디비를 설계하는 방법은 다르겠지만, 개인적으로 테이블, 컬럼 등 대문자와 약어를 사용하는 것을 좋아합니다.. 풀네임으로 컬럼의 이름을 작성하면 너무 오브젝트의 명이 너무 길어 코딩하기에 어려워진다는?? 생각과 이전에는 dbms 자체에서 30바이트로 이름을 설계할 수 있는 것을 제한했었는데,, 물론 요즘에는 100바이트 넘게 가능하다고 하나, 여러모로 길면 불편하다는 판단하에 대부분의 사람들이 30을 기준으로 설계한다고 들었습니다. 이번에는 char와 varchar의 차이점에 대해서 구글링을 통해 알아낸 결과, 고정 크기는 char라는 정보를 알고 이게 또 연산이 더 빠르다는 장점이 있다고 해서 Enum 값으로 설계할 수 있는 부분은 모두 char로 작성해봤습니다. Id 값은 필드를 구분하기 위한 것이면 Varchar, 서로 계산하기 위한 목적이면 INT를 사용한다고 합니다. 물론 체계를 어떻게 나누는지에 따라 다르겠지만, 이번 당근마켓을 기준으로 봤을 때 유저의 Id 값은 #GH249124 등 순서대로 증가하는 것이 아닌, 문자가 섞여 있는 것으로 확인하여 Varchar 작성했습니다. 하나의 테이블에 많은 컬럼을 다 넣은 경향이 없지는 않지만, 조인하는 것이 비용적으로 많이 든다는 생각을 계속 가져가면서 실제로 사용하면서 이 부분은 나눠야겠다라고 판단할 때 나누는 것이 더 좋다고 했던 조언이 기억에 남아 한 테이블에 넣었습니다. 테이블을 쪼개는 것은 성능보다도 사실 데이터 무결성과 정합성 차원에서 먼저 검토를 해야 한다고 하지만, 이 부분에 대해서 이해를 완벽하게 하지 못해 일단 시간이 부족하여 돌아갈 수 있도록 설계했습니다. 여기까지가 이번 모델링을 하면서 고려했던 부분들 입니다.
