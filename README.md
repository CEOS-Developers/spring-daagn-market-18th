# ë‹¹ê·¼ë§ˆì¼“ í´ë¡ 

---

# ğŸŒ±Â 2ì£¼ì°¨ ë¯¸ì…˜

## 1ï¸âƒ£Â ë‹¹ê·¼ ë§ˆì¼“ì˜ DBë¥¼ ëª¨ë¸ë§í•´ìš”

- ë¬¼ê±´ ì˜¬ë¦¬ê¸°
- ë¬¼ê±´ ì°¾ê¸°
- 1:1 ì±„íŒ…
- êµ¬ë§¤ í™•ì •
- ë¦¬ë·°(ì˜¨ë„)

[ë‹¹ê·¼ë§ˆì¼“ ëª¨ë¸ë§](https://www.erdcloud.com/d/za7jEwYXR2iz545rX)

![Untitled](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/70761da6-0ecf-4e9c-9cd4-818511cd2586)

DB ëª¨ë¸ë§

| ì—”í‹°í‹°ëª…(ë…¼ë¦¬) | í…Œì´ë¸”ëª…(ë¬¼ë¦¬) | ì„¤ëª… |
| --- | --- | --- |
| íšŒì› | members | íšŒì› ì •ë³´ë¥¼ ì €ì¥ |
| ê²Œì‹œê¸€ | posts | íšŒì›ì€ ì—¬ëŸ¬ ê°œì˜ ê²Œì‹œê¸€(ì¤‘ê³ ë¬¼í’ˆ)ì„ ì˜¬ë¦´ ìˆ˜ ìˆìŒ |
| ê²Œì‹œê¸€ ì´ë¯¸ì§€ | item_images | ê²Œì‹œê¸€ì˜ ì´ë¯¸ì§€ ë§í¬ë¥¼ ì €ì¥ |
| ì¹´í…Œê³ ë¦¬ | categories | ê²Œì‹œê¸€ì˜ ì¹´í…Œê³ ë¦¬ ë²”ì£¼ |
| ê±°ë˜ ì™„ë£Œ | completed_deals | ì™„ë£Œëœ ê±°ë˜ |
| ê±°ë˜ í›„ê¸° | deal_reviews | ì™„ë£Œëœ ê±°ë˜ì˜ ê±°ë˜ í›„ê¸° |
| ì±„íŒ…ë°© | chat_rooms | ì¤‘ê³ ë¬¼ê±´ ê²Œì‹œê¸€ì— ìƒì„±ë˜ëŠ” ì±„íŒ…ë°© |
| íšŒì›-ì±„íŒ…ë°© (ì—°ê²°í…Œì´ë¸”) | members_chatrooms | íšŒì› ê³¼ ì±„íŒ…ë°© ì„ ë§¤í•‘í•˜ëŠ” í…Œì´ë¸” |
| ì±„íŒ… ë©”ì‹œì§€ | chat_messages | ì±„íŒ… ë°œì‹ ìì™€ ë‚´ìš©ì„ ì €ì¥ |

### ëª¨ë¸ë§ ê³¼ì •ì—ì„œ í•œ ê³ ë¯¼

**1. FK ë¥¼ ê¼­ ë‹¤ ì¨ì•¼í• ê¹Œ?**  

   FK ì“¸ ë•Œ ì¥ì  : ë°ì´í„° ë¬´ê²°ì„±, join ì„±ëŠ¥

   FK ì•ˆ ì“¸ ë•Œ ì¥ì  : ê°œë°œ í¸ì˜ì„± í–¥ìƒ, í™•ì¥ì— ìœ ë¦¬, ìˆ˜ë™ìœ¼ë¡œ DB ì‘ì—…ì´ í¸ë¦¬, ì§„ì§œ í˜¹ì‹œë„ ëª¨ë¥¼ ëŒ€ì°¸ì‚¬ ë°©ì§€(?)

   ( + FK ë¥¼ ì•ˆ ì“´ë‹¤ë©´ join ì„±ëŠ¥ì„ ìœ„í•´ ì¸ë±ìŠ¤ ì‚¬ìš©ì´ ê±°ì˜ í•„ìˆ˜ì  )

   ê³¼ì œ ëª¨ë¸ë§ì—ì„œëŠ” FK ë¥¼ ì ìš©í–ˆìŒ


**2. ì‹ë³„ vs ë¹„ì‹ë³„**

   ìœ ì—°í•œ ì„¤ê³„ë¥¼ ìœ„í•´ ë¹„ì‹ë³„ ê´€ê³„ë¥¼ ì„ í˜¸í•¨


**3. ë‹¹ê·¼ë§ˆì¼“ì˜ ë¡œê·¸ì¸ ë°©ì‹ì— ë”°ë¥¸ íšŒì› ì—”í‹°í‹° ì„¤ê³„**

  ![Untitled 1](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/a7aa3e79-37fd-41ce-afa0-00029569322b)

   íšŒì›ê°€ì…ì„ í•  ë•Œ ì•„ì´ë””, íŒ¨ìŠ¤ì›Œë“œ ë°©ì‹ì´ ì•„ë‹Œ íœ´ëŒ€í° ë²ˆí˜¸ë¡œ ì „ì†¡ëœ ì¸ì¦ ì½”ë“œë¥¼ ì¸ì¦í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ íšŒì›ê°€ì…ì´ ì™„ë£Œëœë‹¤. ì•„ì´ë””ê°€ íœ´ëŒ€í° ë²ˆí˜¸ê°€ ë˜ëŠ”ì…ˆì´ê³  íŒ¨ìŠ¤ì›Œë“œëŠ” ë”°ë¡œ ì—†ë‹¤.



**4. ì—”í‹°í‹° ë„¤ì´ë° : ì¤‘ê³ ë¬¼ê±´(items,product..) vs ê²Œì‹œê¸€(post..)**

   ì¼ë°˜ì ì¸ ì´ì»¤ë¨¸ìŠ¤ì™€ ë‹¤ë¥´ê²Œ ì¤‘ê³ ê±°ë˜ëŠ” **ë¬¼í’ˆ**ì´ **ê²Œì‹œê¸€**ì˜ ì—­í• ë„ ê²¸í•œë‹¤.

   ë„¤ì´ë°ì„ ì–´ë–»ê²Œ í• ê¹Œ ê³ ë¯¼ì„ í–ˆëŠ”ë°, **ê²Œì‹œê¸€(posts)** ë¡œ ê²°ì •í•¨

   ê·¼ê±°

    - ë‹¹ê·¼ ì„œë¹„ìŠ¤ ë‚´ ì—ì„œ ê¸€ ì“°ê¸° ë²„íŠ¼ì„ í´ë¦­í•œ ë’¤ ì¤‘ê³ ë¬¼í’ˆì„ ì˜¬ë¦¬ëŠ” í¼ì´ ëœ¸
    - ë¬¼í’ˆì— ëŒ€í•œ ì±„íŒ…ë°© ë³´ë‹¤ëŠ” ê²Œì‹œê¸€ì— ëŒ€í•œ ì±„íŒ…ë°©ì´ ë” ìì—°ìŠ¤ëŸ½ë‹¤ê³  ìƒê°

<br>

**5. ê±°ë˜ ì™„ë£Œ ì™€ ê±°ë˜ í›„ê¸°**

   ![Untitled 2](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/a7a69063-95f5-4d16-87e5-20c4ac754776)

   ê±°ë˜ ì™„ë£Œ ì²˜ë¦¬ë¥¼ ìœ„í•´ items í…Œì´ë¸”ì— íŒë§¤ìì™€ êµ¬ë§¤ì ì»¬ëŸ¼ì„ ë‘˜ ë‹¤ ë†“ì„ ìˆ˜ ë„ ìˆê² ì§€ë§Œ, ê±°ë˜ ì™„ë£Œ í…Œì´ë¸”ì„ ë³„ë„ë¡œ ë¶„ë¦¬í–ˆìŒ <br><br>

   ê·¼ê±°

    - nullable í•œ FK ë¥¼ ìµœëŒ€í•œ ì¤„ì´ê³  ì‹¶ì—ˆìŒ (êµ¬ë§¤ì ID)
    - ê±°ë˜ ë¼ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ê±°ë˜ ì™„ë£ŒëŠ” í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ì´ë¯€ë¡œ ë³„ë„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ ê´œì°®ê² ë‹¤ê³  ìƒê°í•¨

<br>
   íšŒì›ì˜ ê²Œì‹œê¸€ ì¡°íšŒ, íšŒì›ì˜ ê±°ë˜ ì™„ë£Œ ì¡°íšŒ, íšŒì›ì˜ ê±°ë˜ í›„ê¸° ì¡°íšŒ ì˜ ì„±ëŠ¥ì„ ìœ„í•´ ê° í…Œì´ë¸”ì— member ë¥¼ ì°¸ì¡°í•œ FK ë¥¼ ë‘ 

<br>


**6. íšŒì›ì˜ ì±„íŒ…ë°©ì„ ì¡°íšŒí•  ë•Œì˜ ì„±ëŠ¥ ê³ ë¯¼**

- case 1) chat_room í…Œì´ë¸”ì— ê²Œì‹œê¸€(posts) ì™€ íšŒì›(members) ì„ ì°¸ì¡°í•˜ëŠ” FKê°€ ì¡´ì¬

  ![Untitled 3](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/eef35ca7-9d2a-49e4-8799-65bd14bf49f9)


- ë‚´ê°€ íŒë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ posts â†’ chat_rooms : ì‚¼ì¤‘ì¡°ì¸ or `whereâ€¦in` ì‚¬ìš©

- ë‚´ê°€ êµ¬ë§¤(í¬ë§)ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ chat_rooms : ì¡°ì¸


- case 2) chat_room í…Œì´ë¸”ì— íŒë§¤ì(seller_id) ì»¬ëŸ¼ì„ FK ë¡œ ì¶”ê°€

  ![Untitled 4](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ea59e70b-4b96-4d56-8cc7-b9eb97bc903f)


chat_room í…Œì´ë¸”ì— íŒë§¤ì id (member ì°¸ì¡° FK) ë¥¼ ë‘ëŠ” ì—­ì •ê·œí™”

- ë‚´ê°€ íŒë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ chat_rooms : ì¡°ì¸

- ë‚´ê°€ êµ¬ë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ chat_rooms : ì¡°ì¸


â‡’ posts í…Œì´ë¸”ê³¼ ë¬´ê´€í•´ì§€ë¯€ë¡œ case 1 ë³´ë‹¤ ë” ê°œì„ ë¨

- case 3) many to many ì‚¬ì´ì— join table ì¶”ê°€

  ![Untitled 5](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ba099f93-b8ff-4dbe-aac4-0d154e38a901)


- ë‚´ê°€ íŒë§¤ì,êµ¬ë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ members_chatrooms â†’ chat_rooms : ì‚¼ì¤‘ì¡°ì¸


ì¥ì 

- íŒë§¤ì, êµ¬ë§¤ìì— ëŒ€í•œ ë¡œì§ ë¶„ê¸°ê°€ í•„ìš” ì—†ì–´ì§
- ì±„íŒ…ë°© ì— ëŒ€í•œ í™•ì¥ì„±ë„ ì¦ê°€í•´ì„œ ì´ ë°©ì‹ì„ ìµœì¢…ì ìœ¼ë¡œ ì„ íƒ

  â‡’ 1:1 ì±„íŒ…ì´ ì•„ë‹Œ ë‹¨ì²´ ì±„íŒ…ë„ ì‰½ê²Œ êµ¬í˜„ ê°€ëŠ¥


### í…Œì´ë¸” ìƒì„¸ ì„¤ëª…

ëª¨ë“  í…Œì´ë¸”ì— createdDate ì™€ updatedDate ì»¬ëŸ¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤ (ERD ìƒì—ëŠ” ìƒëµë¨)
    


- íšŒì› (members)

  ![Untitled 6](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/785e117c-4465-4234-87a1-02c3f91397a7)


- íšŒì›íƒˆí‡´ì—¬ë¶€ : íƒˆí‡´ ì‹œ, DELETE ê°€ ì•„ë‹Œ UPDATE ë¡œ ë°ì´í„° ìœ ì§€ ë° ì‚¬ê¸° ìœ ì € ë°©ì§€
- ì§€ì—­ : ê¹Šê²Œ ë“¤ì–´ê°€ë©´ ê³ ë ¤í•  ì‚¬í•­ì´ ë„ˆë¬´ ë§ì•„ì„œ ìš°ì„ ì€ ë‹¨ìˆœ string ìœ¼ë¡œ ì²˜ë¦¬
  

- ê²Œì‹œê¸€ (posts)

  ![Untitled 7](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/f80565c5-5100-4787-ab05-eb8f6055a4a4)
  

- ê²Œì‹œê¸€ ì´ë¯¸ì§€ (post_images)

  ![Untitled 8](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ca95419f-0c42-463a-82cb-596e1df2c7ec)
  

- ì¹´í…Œê³ ë¦¬ (categories)

  ![Untitled 9](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/31e71156-24e0-4638-b99c-9e35f1d1ee6b)
  

- ê±°ë˜ ì™„ë£Œ (completed_deals)

  ![Untitled 10](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/b422bd45-0e30-4546-8412-1ff94a4ffe9c)
  

- ê±°ë˜ í›„ê¸° (deal_reviews)

  <img width="318" alt="Untitled 11" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/31cf03d8-8ccd-4613-ab6a-68f554f2cc6d">
  

- ì±„íŒ…ë°© (chat_rooms)

  <img width="227" alt="Untitled 12" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/78d0ce8d-bb05-4ace-92ce-6d4289b32f7e">
  

- íšŒì›-ì±„íŒ…ë°© (members_chatrooms)

  <img width="267" alt="Untitled 13" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/e95b1fd6-4ad0-4496-bba8-99e386203f36">
  

- ì±„íŒ… ë©”ì‹œì§€ (chat_messages)

  <img width="302" alt="Untitled 14" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/a63073e1-d12d-4f36-87df-4d2c200a3290">


### ì „ì²´ ì—°ê´€ ê´€ê³„

![Untitled 15](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ff9c4d87-c258-479e-87ed-2a1e0dbb4126)

---

## 2ï¸âƒ£Â Repository ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ìš”

Post Entity ì—ëŒ€í•œ Repository ë¥¼ ë§Œë“¤ê³  @DataJpaTest ë¥¼ í†µí•´ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì

```java
package com.ceos18.springboot.repository;

import com.ceos18.springboot.domain.entity.Category;
import com.ceos18.springboot.domain.entity.Member;
import com.ceos18.springboot.domain.entity.Post;
import com.ceos18.springboot.domain.entity.enums.DealType;
import com.ceos18.springboot.domain.entity.enums.PostStatus;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.boot.test.autoconfigure.orm.jpa.TestEntityManager;

import java.math.BigDecimal;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class PostRepositoryTest {

	@Autowired
	private TestEntityManager em;

	@Autowired
	private PostRepository postRepository;

	@Test
	public void testSaveAndFind() {
		// Given

		Category category = Category.builder()
				.name("ë„ì„œ")
				.build();

		Member member = Member.builder()
				.phoneNumber("010-1111-2222")
				.isWithdrawal(false)
				.mannerRating(BigDecimal.valueOf(36.5))
				.region("ì„œìš¸")
				.build();

		em.persist(category);
		em.persist(member);

		Post post1 = Post.builder()
				.category(category)
				.seller(member)
				.title("title")
				.dealType(DealType.SELL)
				.isPriceOffer(true)
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		Post post2 = Post.builder()
				.category(category)
				.seller(member)
				.title("title")
				.dealType(DealType.SELL)
				.isPriceOffer(true)
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		Post post3 = Post.builder()
				.category(category)
				.seller(member)
				.title("title")
				.dealType(DealType.SELL)
				.isPriceOffer(true)
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		// When
		em.persist(post1);
		em.persist(post2);
		em.persist(post3);

		List<Post> posts = postRepository.findAll();

		// Then
		assertThat(posts).hasSize(3);
		assertThat(posts).contains(post1, post2, post3);
	}
}
```

- Post Entity ëŠ” Category ì™€ Member ë¥¼ ì°¸ì¡°í•˜ê³  ìˆì–´ì„œ Category ì™€ Member ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë¨¼ì € ìƒì„±í•œ ë’¤ persist í•´ì¤˜ì•¼ í•œë‹¤.
  <br><br>
- í…ŒìŠ¤íŠ¸ í†µê³¼

    ![Untitled 16](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/122b2edd-f297-4e2c-b0b9-b2a18fb91891)

## TroubleShooting

- java springboot ì—ì„œëŠ” íŒ¨í‚¤ì§€ëª…ìœ¼ë¡œ enum ì´ ì•ˆ ëœë‹¤
- ì •í™•í•œ ì‹¤ìˆ˜ ê³„ì‚°ì´ í•„ìš”í•  ë•Œì—ëŠ” float, double ëŒ€ì‹  BigDecimal ì„ ì‚¬ìš©í•˜ì
- [https://codingdog.tistory.com/entry/mysql-decimal-vs-double-ê³ ì •-ì†Œìˆ˜ì ê³¼-ë¶€ë™-ì†Œìˆ˜ì ](https://codingdog.tistory.com/entry/mysql-decimal-vs-double-%EA%B3%A0%EC%A0%95-%EC%86%8C%EC%88%98%EC%A0%90%EA%B3%BC-%EB%B6%80%EB%8F%99-%EC%86%8C%EC%88%98%EC%A0%90)