# ë‹¹ê·¼ë§ˆì¼“ í´ë¡ 

---

# ğŸŒ±Â 2ì£¼ì°¨ ë¯¸ì…˜

## 1ï¸âƒ£Â ë‹¹ê·¼ ë§ˆì¼“ì˜ DBë¥¼ ëª¨ë¸ë§í•´ìš”

- ë¬¼ê±´ ì˜¬ë¦¬ê¸°
- ë¬¼ê±´ ì°¾ê¸°
- 1:1 ì±„íŒ…
- êµ¬ë§¤ í™•ì •
- ë¦¬ë·°(ì˜¨ë„)

[ë‹¹ê·¼ë§ˆì¼“ ëª¨ë¸ë§](https://www.erdcloud.com/d/za7jEwYXR2iz545rX)

![Untitled](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/70761da6-0ecf-4e9c-9cd4-818511cd2586)

DB ëª¨ë¸ë§

| ì—”í‹°í‹°ëª…(ë…¼ë¦¬) | í…Œì´ë¸”ëª…(ë¬¼ë¦¬) | ì„¤ëª… |
| --- | --- | --- |
| íšŒì› | members | íšŒì› ì •ë³´ë¥¼ ì €ì¥ |
| ê²Œì‹œê¸€ | posts | íšŒì›ì€ ì—¬ëŸ¬ ê°œì˜ ê²Œì‹œê¸€(ì¤‘ê³ ë¬¼í’ˆ)ì„ ì˜¬ë¦´ ìˆ˜ ìˆìŒ |
| ê²Œì‹œê¸€ ì´ë¯¸ì§€ | item_images | ê²Œì‹œê¸€ì˜ ì´ë¯¸ì§€ ë§í¬ë¥¼ ì €ì¥ |
| ì¹´í…Œê³ ë¦¬ | categories | ê²Œì‹œê¸€ì˜ ì¹´í…Œê³ ë¦¬ ë²”ì£¼ |
| ê±°ë˜ ì™„ë£Œ | completed_deals | ì™„ë£Œëœ ê±°ë˜ |
| ê±°ë˜ í›„ê¸° | deal_reviews | ì™„ë£Œëœ ê±°ë˜ì˜ ê±°ë˜ í›„ê¸° |
| ì±„íŒ…ë°© | chat_rooms | ì¤‘ê³ ë¬¼ê±´ ê²Œì‹œê¸€ì— ìƒì„±ë˜ëŠ” ì±„íŒ…ë°© |
| íšŒì›-ì±„íŒ…ë°© (ì—°ê²°í…Œì´ë¸”) | members_chatrooms | íšŒì› ê³¼ ì±„íŒ…ë°© ì„ ë§¤í•‘í•˜ëŠ” í…Œì´ë¸” |
| ì±„íŒ… ë©”ì‹œì§€ | chat_messages | ì±„íŒ… ë°œì‹ ìì™€ ë‚´ìš©ì„ ì €ì¥ |

### ëª¨ë¸ë§ ê³¼ì •ì—ì„œ í•œ ê³ ë¯¼

**1. FK ë¥¼ ê¼­ ë‹¤ ì¨ì•¼í• ê¹Œ?**  

   FK ì“¸ ë•Œ ì¥ì  : ë°ì´í„° ë¬´ê²°ì„±, join ì„±ëŠ¥

   FK ì•ˆ ì“¸ ë•Œ ì¥ì  : ê°œë°œ í¸ì˜ì„± í–¥ìƒ, í™•ì¥ì— ìœ ë¦¬, ìˆ˜ë™ìœ¼ë¡œ DB ì‘ì—…ì´ í¸ë¦¬, ì§„ì§œ í˜¹ì‹œë„ ëª¨ë¥¼ ëŒ€ì°¸ì‚¬ ë°©ì§€(?)

   ( + FK ë¥¼ ì•ˆ ì“´ë‹¤ë©´ join ì„±ëŠ¥ì„ ìœ„í•´ ì¸ë±ìŠ¤ ì‚¬ìš©ì´ ê±°ì˜ í•„ìˆ˜ì  )

   ê³¼ì œ ëª¨ë¸ë§ì—ì„œëŠ” FK ë¥¼ ì ìš©í–ˆìŒ


**2. ì‹ë³„ vs ë¹„ì‹ë³„**

   ìœ ì—°í•œ ì„¤ê³„ë¥¼ ìœ„í•´ ë¹„ì‹ë³„ ê´€ê³„ë¥¼ ì„ í˜¸í•¨


**3. ë‹¹ê·¼ë§ˆì¼“ì˜ ë¡œê·¸ì¸ ë°©ì‹ì— ë”°ë¥¸ íšŒì› ì—”í‹°í‹° ì„¤ê³„**

  ![Untitled 1](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/a7aa3e79-37fd-41ce-afa0-00029569322b)

   íšŒì›ê°€ì…ì„ í•  ë•Œ ì•„ì´ë””, íŒ¨ìŠ¤ì›Œë“œ ë°©ì‹ì´ ì•„ë‹Œ íœ´ëŒ€í° ë²ˆí˜¸ë¡œ ì „ì†¡ëœ ì¸ì¦ ì½”ë“œë¥¼ ì¸ì¦í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ íšŒì›ê°€ì…ì´ ì™„ë£Œëœë‹¤. ì•„ì´ë””ê°€ íœ´ëŒ€í° ë²ˆí˜¸ê°€ ë˜ëŠ”ì…ˆì´ê³  íŒ¨ìŠ¤ì›Œë“œëŠ” ë”°ë¡œ ì—†ë‹¤.



**4. ì—”í‹°í‹° ë„¤ì´ë° : ì¤‘ê³ ë¬¼ê±´(items,product..) vs ê²Œì‹œê¸€(post..)**

   ì¼ë°˜ì ì¸ ì´ì»¤ë¨¸ìŠ¤ì™€ ë‹¤ë¥´ê²Œ ì¤‘ê³ ê±°ë˜ëŠ” **ë¬¼í’ˆ**ì´ **ê²Œì‹œê¸€**ì˜ ì—­í• ë„ ê²¸í•œë‹¤.

   ë„¤ì´ë°ì„ ì–´ë–»ê²Œ í• ê¹Œ ê³ ë¯¼ì„ í–ˆëŠ”ë°, **ê²Œì‹œê¸€(posts)** ë¡œ ê²°ì •í•¨

   ê·¼ê±°

    - ë‹¹ê·¼ ì„œë¹„ìŠ¤ ë‚´ ì—ì„œ ê¸€ ì“°ê¸° ë²„íŠ¼ì„ í´ë¦­í•œ ë’¤ ì¤‘ê³ ë¬¼í’ˆì„ ì˜¬ë¦¬ëŠ” í¼ì´ ëœ¸
    - ë¬¼í’ˆì— ëŒ€í•œ ì±„íŒ…ë°© ë³´ë‹¤ëŠ” ê²Œì‹œê¸€ì— ëŒ€í•œ ì±„íŒ…ë°©ì´ ë” ìì—°ìŠ¤ëŸ½ë‹¤ê³  ìƒê°

<br>

**5. ê±°ë˜ ì™„ë£Œ ì™€ ê±°ë˜ í›„ê¸°**

   ![Untitled 2](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/a7a69063-95f5-4d16-87e5-20c4ac754776)

   ê±°ë˜ ì™„ë£Œ ì²˜ë¦¬ë¥¼ ìœ„í•´ items í…Œì´ë¸”ì— íŒë§¤ìì™€ êµ¬ë§¤ì ì»¬ëŸ¼ì„ ë‘˜ ë‹¤ ë†“ì„ ìˆ˜ ë„ ìˆê² ì§€ë§Œ, ê±°ë˜ ì™„ë£Œ í…Œì´ë¸”ì„ ë³„ë„ë¡œ ë¶„ë¦¬í–ˆìŒ <br><br>

   ê·¼ê±°

    - nullable í•œ FK ë¥¼ ìµœëŒ€í•œ ì¤„ì´ê³  ì‹¶ì—ˆìŒ (êµ¬ë§¤ì ID)
    - ê±°ë˜ ë¼ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ê±°ë˜ ì™„ë£ŒëŠ” í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ì´ë¯€ë¡œ ë³„ë„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ ê´œì°®ê² ë‹¤ê³  ìƒê°í•¨

<br>
   íšŒì›ì˜ ê²Œì‹œê¸€ ì¡°íšŒ, íšŒì›ì˜ ê±°ë˜ ì™„ë£Œ ì¡°íšŒ, íšŒì›ì˜ ê±°ë˜ í›„ê¸° ì¡°íšŒ ì˜ ì„±ëŠ¥ì„ ìœ„í•´ ê° í…Œì´ë¸”ì— member ë¥¼ ì°¸ì¡°í•œ FK ë¥¼ ë‘ 

<br>


**6. íšŒì›ì˜ ì±„íŒ…ë°©ì„ ì¡°íšŒí•  ë•Œì˜ ì„±ëŠ¥ ê³ ë¯¼**

- case 1) chat_room í…Œì´ë¸”ì— ê²Œì‹œê¸€(posts) ì™€ íšŒì›(members) ì„ ì°¸ì¡°í•˜ëŠ” FKê°€ ì¡´ì¬

  ![Untitled 3](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/eef35ca7-9d2a-49e4-8799-65bd14bf49f9)


- ë‚´ê°€ íŒë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ posts â†’ chat_rooms : ì‚¼ì¤‘ì¡°ì¸ or `whereâ€¦in` ì‚¬ìš©

- ë‚´ê°€ êµ¬ë§¤(í¬ë§)ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ chat_rooms : ì¡°ì¸


- case 2) chat_room í…Œì´ë¸”ì— íŒë§¤ì(seller_id) ì»¬ëŸ¼ì„ FK ë¡œ ì¶”ê°€

  ![Untitled 4](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ea59e70b-4b96-4d56-8cc7-b9eb97bc903f)


chat_room í…Œì´ë¸”ì— íŒë§¤ì id (member ì°¸ì¡° FK) ë¥¼ ë‘ëŠ” ì—­ì •ê·œí™”

- ë‚´ê°€ íŒë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ chat_rooms : ì¡°ì¸

- ë‚´ê°€ êµ¬ë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ chat_rooms : ì¡°ì¸


â‡’ posts í…Œì´ë¸”ê³¼ ë¬´ê´€í•´ì§€ë¯€ë¡œ case 1 ë³´ë‹¤ ë” ê°œì„ ë¨

- case 3) many to many ì‚¬ì´ì— join table ì¶”ê°€

  ![Untitled 5](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ba099f93-b8ff-4dbe-aac4-0d154e38a901)


- ë‚´ê°€ íŒë§¤ì,êµ¬ë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ members_chatrooms â†’ chat_rooms : ì‚¼ì¤‘ì¡°ì¸


ì¥ì 

- íŒë§¤ì, êµ¬ë§¤ìì— ëŒ€í•œ ë¡œì§ ë¶„ê¸°ê°€ í•„ìš” ì—†ì–´ì§
- ì±„íŒ…ë°© ì— ëŒ€í•œ í™•ì¥ì„±ë„ ì¦ê°€í•´ì„œ ì´ ë°©ì‹ì„ ìµœì¢…ì ìœ¼ë¡œ ì„ íƒ

  â‡’ 1:1 ì±„íŒ…ì´ ì•„ë‹Œ ë‹¨ì²´ ì±„íŒ…ë„ ì‰½ê²Œ êµ¬í˜„ ê°€ëŠ¥


### í…Œì´ë¸” ìƒì„¸ ì„¤ëª…

ëª¨ë“  í…Œì´ë¸”ì— createdDate ì™€ updatedDate ì»¬ëŸ¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤ (ERD ìƒì—ëŠ” ìƒëµë¨)
    


- íšŒì› (members)

  ![Untitled 6](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/785e117c-4465-4234-87a1-02c3f91397a7)


- íšŒì›íƒˆí‡´ì—¬ë¶€ : íƒˆí‡´ ì‹œ, DELETE ê°€ ì•„ë‹Œ UPDATE ë¡œ ë°ì´í„° ìœ ì§€ ë° ì‚¬ê¸° ìœ ì € ë°©ì§€
- ì§€ì—­ : ê¹Šê²Œ ë“¤ì–´ê°€ë©´ ê³ ë ¤í•  ì‚¬í•­ì´ ë„ˆë¬´ ë§ì•„ì„œ ìš°ì„ ì€ ë‹¨ìˆœ string ìœ¼ë¡œ ì²˜ë¦¬
  

- ê²Œì‹œê¸€ (posts)

  ![Untitled 7](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/f80565c5-5100-4787-ab05-eb8f6055a4a4)
  

- ê²Œì‹œê¸€ ì´ë¯¸ì§€ (post_images)

  ![Untitled 8](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ca95419f-0c42-463a-82cb-596e1df2c7ec)
  

- ì¹´í…Œê³ ë¦¬ (categories)

  ![Untitled 9](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/31e71156-24e0-4638-b99c-9e35f1d1ee6b)
  

- ê±°ë˜ ì™„ë£Œ (completed_deals)

  ![Untitled 10](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/b422bd45-0e30-4546-8412-1ff94a4ffe9c)
  

- ê±°ë˜ í›„ê¸° (deal_reviews)

  <img width="318" alt="Untitled 11" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/31cf03d8-8ccd-4613-ab6a-68f554f2cc6d">
  

- ì±„íŒ…ë°© (chat_rooms)

  <img width="227" alt="Untitled 12" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/78d0ce8d-bb05-4ace-92ce-6d4289b32f7e">
  

- íšŒì›-ì±„íŒ…ë°© (members_chatrooms)

  <img width="267" alt="Untitled 13" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/e95b1fd6-4ad0-4496-bba8-99e386203f36">
  

- ì±„íŒ… ë©”ì‹œì§€ (chat_messages)

  <img width="302" alt="Untitled 14" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/a63073e1-d12d-4f36-87df-4d2c200a3290">


### ì „ì²´ ì—°ê´€ ê´€ê³„

![Untitled 15](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ff9c4d87-c258-479e-87ed-2a1e0dbb4126)

---

## 2ï¸âƒ£Â Repository ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ìš”

Post Entity ì—ëŒ€í•œ Repository ë¥¼ ë§Œë“¤ê³  @DataJpaTest ë¥¼ í†µí•´ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì

```java
package com.ceos18.springboot.repository;

import com.ceos18.springboot.domain.entity.Category;
import com.ceos18.springboot.domain.entity.Member;
import com.ceos18.springboot.domain.entity.Post;
import com.ceos18.springboot.domain.entity.enums.DealType;
import com.ceos18.springboot.domain.entity.enums.PostStatus;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.boot.test.autoconfigure.orm.jpa.TestEntityManager;

import java.math.BigDecimal;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class PostRepositoryTest {

	@Autowired
	private TestEntityManager em;

	@Autowired
	private PostRepository postRepository;

	@Test
	public void testSaveAndFind() {
		// Given

		Category category = Category.builder()
				.name("ë„ì„œ")
				.build();

		Member member = Member.builder()
				.phoneNumber("010-1111-2222")
				.isWithdrawal(false)
				.mannerRating(BigDecimal.valueOf(36.5))
				.region("ì„œìš¸")
				.build();

		em.persist(category);
		em.persist(member);

		Post post1 = Post.builder()
				.category(category)
				.seller(member)
				.title("title")
				.dealType(DealType.SELL)
				.isPriceOffer(true)
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		Post post2 = Post.builder()
				.category(category)
				.seller(member)
				.title("title")
				.dealType(DealType.SELL)
				.isPriceOffer(true)
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		Post post3 = Post.builder()
				.category(category)
				.seller(member)
				.title("title")
				.dealType(DealType.SELL)
				.isPriceOffer(true)
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		// When
		em.persist(post1);
		em.persist(post2);
		em.persist(post3);

		List<Post> posts = postRepository.findAll();

		// Then
		assertThat(posts).hasSize(3);
		assertThat(posts).contains(post1, post2, post3);
	}
}
```

- Post Entity ëŠ” Category ì™€ Member ë¥¼ ì°¸ì¡°í•˜ê³  ìˆì–´ì„œ Category ì™€ Member ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë¨¼ì € ìƒì„±í•œ ë’¤ persist í•´ì¤˜ì•¼ í•œë‹¤.
  <br><br>
- í…ŒìŠ¤íŠ¸ í†µê³¼

    ![Untitled 16](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/122b2edd-f297-4e2c-b0b9-b2a18fb91891)

## TroubleShooting

- java springboot ì—ì„œëŠ” íŒ¨í‚¤ì§€ëª…ìœ¼ë¡œ enum ì´ ì•ˆ ëœë‹¤
- ì •í™•í•œ ì‹¤ìˆ˜ ê³„ì‚°ì´ í•„ìš”í•  ë•Œì—ëŠ” float, double ëŒ€ì‹  BigDecimal ì„ ì‚¬ìš©í•˜ì
- [https://codingdog.tistory.com/entry/mysql-decimal-vs-double-ê³ ì •-ì†Œìˆ˜ì ê³¼-ë¶€ë™-ì†Œìˆ˜ì ](https://codingdog.tistory.com/entry/mysql-decimal-vs-double-%EA%B3%A0%EC%A0%95-%EC%86%8C%EC%88%98%EC%A0%90%EA%B3%BC-%EB%B6%80%EB%8F%99-%EC%86%8C%EC%88%98%EC%A0%90)

---

# ğŸŒ±3ì£¼ì°¨ ë¯¸ì…˜

# í”„ë¡œì íŠ¸ íŒ¨í‚¤ì§€ êµ¬ì¡°

![Untitled 17](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/6dc9be1f-9b94-4e58-953f-0ec5d8de0224)

Post (ê²Œì‹œê¸€) ë„ë©”ì¸ì— ëŒ€í•´ CRUD ë¥¼ ë§Œë“¤ì–´ë´…ì‹œë‹¤.

í˜„ì¬ ì œ Post ì—”í‹°í‹°ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```java
package com.ceos18.springboot.domain.entity;

import com.ceos18.springboot.domain.entity.base.BaseTimeEntity;
import com.ceos18.springboot.domain.entity.enums.DealType;
import com.ceos18.springboot.domain.entity.enums.PostStatus;
import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@Table(name = "posts")
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Post extends BaseTimeEntity {
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id; // PK

	@ManyToOne
	@JoinColumn(name = "category_id", nullable = false)
	private Category category;

	@ManyToOne
	@JoinColumn(name = "seller_id", nullable = false)
	private Member seller;

	@Column(name = "title", nullable = false)
	private String title;

	@Column(name = "deal_type", nullable = false)
	@Enumerated(EnumType.STRING)
	private DealType dealType;

	@Column(name = "description")
	private String description;

	@Column(name = "deal_place")
	private String dealPlace;

	@Column(name = "price")
	private BigDecimal price;

	@Column(name = "is_price_offer", nullable = false)
	private Boolean isPriceOffer;

	@Column(name = "status", nullable = false)
	@Enumerated(EnumType.STRING)
	private PostStatus status;

	@Column(name = "liked_count", nullable = false)
	private int likedCount;

	@Column(name = "view_count", nullable = false)
	private int viewCount;

	@Column(name = "pullup_at")
	private LocalDateTime pullupAt;

}
```

Post ëŠ” Category ì™€ Member(seller) ë¥¼ ì°¸ì¡°í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì‚¬ì „ì— Category ì™€ Member ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ì„ì‹œë¡œ InitDb ë¼ëŠ” í´ë˜ìŠ¤ì—ì„œ ìŠ¤í”„ë§ì´ êµ¬ë™ë  ë•Œ Category ì™€ Member DB ë¥¼ ë§Œë“¤ì–´ì£¼ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

`InitDb`

```java
package com.ceos18.springboot;

import com.ceos18.springboot.domain.entity.Category;
import com.ceos18.springboot.domain.entity.Member;
import com.ceos18.springboot.repository.CategoryRepository;
import com.ceos18.springboot.repository.MemberRepository;
import jakarta.annotation.PostConstruct;
import jakarta.persistence.EntityManager;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

@Component
@RequiredArgsConstructor
public class InitDb {

	private final InitService initService;

	@PostConstruct
	public void init() {
		initService.dbInit1();
	}

	@Component
	@Transactional
	@RequiredArgsConstructor
	static class InitService {

		private final MemberRepository memberRepository;
		private final CategoryRepository categoryRepository;

		public void dbInit1() {
			System.out.println("Init1" + this.getClass());

			Member member = new Member();
			member.setPhoneNumber("010-1111-2222");
			member.setEmail("abc@gmail.com");

			memberRepository.save(member);

			Category category = new Category();
			category.setName("ì „ìê¸°ê¸°");

			categoryRepository.save(category);
		}

	}
}
```

Category ì™€ Member í•˜ë‚˜ì”©ì„ save í•´ì¤ë‹ˆë‹¤.

![Untitled 18](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/7fd61359-0a75-4713-be2b-19d424d6dbde)

![Untitled 19](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/17955e5a-aac5-4f2e-b0f0-91a249b45af4)



# API ì„¤ê³„

![Untitled 20](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/c3309bb8-b973-46ae-b252-916161fb0ea3)

## post ìƒì„±

**POST : /api/v1/post**

- parameter : ì—†ìŒ
- request body

```java
{
  "title": "string",
  "categoryId": 0,
  "dealType": "SELL",
  "description": "string",
  "dealPlace": "string",
  "price": 0,
  "isPriceOffer": true
}
```

- ì„±ê³µ response : post ì˜ id ë¥¼ ë°˜í™˜

```java
1
```

## post ì „ì²´ ì¡°íšŒ

**GET : /api/v1/post**

- parameter : ì—†ìŒ
- request body : ì—†ìŒ

- ì„±ê³µ response

```java
[
  {
    "id": 0,
    "category": {
      "id": 0,
      "name": "string"
    },
    "seller": {
      "id": 0,
      "nickName": "string"
    },
    "title": "string",
    "dealType": "SELL",
    "description": "string",
    "dealPlace": "string",
    "price": 0,
    "isPriceOffer": true,
    "status": "SALE",
    "likedCount": 0,
    "viewCount": 0,
    "pullupAt": "2023-10-07T14:29:51.516Z"
  }
]
```

## post ë‹¨ê±´ ì¡°íšŒ

**GET : /api/v1/post/{postId}**

- parameter : postId
- request body : ì—†ìŒ

- ì„±ê³µ response

```java
{
  "id": 0,
  "category": {
    "id": 0,
    "name": "string"
  },
  "seller": {
    "id": 0,
    "nickName": "string"
  },
  "title": "string",
  "dealType": "SELL",
  "description": "string",
  "dealPlace": "string",
  "price": 0,
  "isPriceOffer": true,
  "status": "SALE",
  "likedCount": 0,
  "viewCount": 0,
  "pullupAt": "2023-10-07T14:32:25.278Z"
}
```

## post ìˆ˜ì •

**PATCH : /api/v1/post/{postId}**

- parameter : `postId`
- request body

    ```java
    {
      "title": "string",
      "categoryId": 0,
      "dealType": "SELL",
      "description": "string",
      "dealPlace": "string",
      "price": 0,
      "isPriceOffer": true
    }
    
    ```


- ì„±ê³µ response : post ì˜ id ë¥¼ ë°˜í™˜

```java
1
```

## post ì‚­ì œ

**DELETE : /api/v1/post/{postId}**

- parameter : `postId`
- request body : ì—†ìŒ

- ì„±ê³µ response : post ì˜ id ë¥¼ ë°˜í™˜

```java
1
```

# Dto ìƒì„±

## request dto

`PostCreateRequestDto`

```java
@Getter
@NoArgsConstructor
public class PostCreateRequestDto {

	private String title;
	private Long categoryId;
	private DealType dealType;
	private String description;
	private String dealPlace;
	private BigDecimal price;
	private Boolean isPriceOffer;

}
```

- Post ë¥¼ ìƒì„±í•  ë•Œ, í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œ ë„˜ì–´ì˜¬ ê°’ì„ ì •ì˜í•©ë‹ˆë‹¤.

`PostUpdateRequestDto`

```java
@Getter
@NoArgsConstructor
public class PostUpdateRequestDto {
	private String title;
	private Long categoryId;
	private DealType dealType;
	private String description;
	private String dealPlace;
	private BigDecimal price;
	private Boolean isPriceOffer;
}
```

- Post ë¥¼ ìˆ˜ì •í•  ë•Œ, í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œ ë„˜ì–´ì˜¬ ê°’ì„ ì •ì˜í•©ë‹ˆë‹¤.

## response dto

```java
@Getter
@Setter
public class PostReadResponseDto {
	private Long id;
	private CategoryVo category; // ì—°ê´€ê´€ê³„
	private MemberVo seller; // // ì—°ê´€ê´€ê³„
	private String title;
	private DealType dealType;
	private String description;
	private String dealPlace;
	private BigDecimal price;
	private Boolean isPriceOffer;
	private PostStatus status;
	private int likedCount;
	private int viewCount;
	private LocalDateTime pullupAt;

	public static PostReadResponseDto fromEntity(Post post) {
		PostReadResponseDto dto = new PostReadResponseDto();
		dto.setId(post.getId());
		dto.setCategory(CategoryVo.fromEntity(post.getCategory()));
		dto.setSeller(MemberVo.fromEntity(post.getSeller()));
		dto.setTitle(post.getTitle());
		dto.setDealType(post.getDealType());
		dto.setDescription(post.getDescription());
		dto.setDealPlace(post.getDealPlace());
		dto.setPrice(post.getPrice());
		dto.setIsPriceOffer(post.getIsPriceOffer());
		dto.setStatus(post.getStatus());
		dto.setLikedCount(post.getLikedCount());
		dto.setViewCount(post.getViewCount());
		dto.setPullupAt(post.getPullupAt());
		return dto;
	}

}
```

dto ì—ì„œ response ê°’ì„ ì•„ë˜ì²˜ëŸ¼ ì£¼ê¸° ìœ„í•´ ë‚´ë¶€ì ìœ¼ë¡œ CategoryVo ì™€ MemberVo ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

```java
{
  "id": 0,
  "category": {
    "id": 0,
    "name": "string"
  },
  "seller": {
    "id": 0,
    "nickName": "string"
  },
  "title": "string",
  "dealType": "SELL",
  "description": "string",
  "dealPlace": "string",
  "price": 0,
  "isPriceOffer": true,
  "status": "SALE",
  "likedCount": 0,
  "viewCount": 0,
  "pullupAt": "2023-10-07T14:32:25.278Z"
}
```

`CategoryVo`

```java
@Getter
@Setter
public class CategoryVo {
	private Long id;
	private String name;

	public static CategoryVo fromEntity(Category category) {
		CategoryVo categoryVo = new CategoryVo();
		categoryVo.setId(category.getId());
		categoryVo.setName(category.getName());
		return categoryVo;
	}

	public Category toEntity() {
		Category category = new Category();
		category.setId(this.id);
		category.setName(this.name);
		return category;
	}
}
```

`MemberVo`

```java
@Getter
@Setter
public class MemberVo {
	private Long id;
	private String nickName;

	public static MemberVo fromEntity(Member member) {
		MemberVo memberVo = new MemberVo();
		memberVo.setId(member.getId());
		memberVo.setNickName(member.getNickName());
		return memberVo;
	}

	public Member toEntity() {
		Member member = new Member();
		member.setId(this.id);
		member.setNickName(this.nickName);
		return member;
	}
}
```

# Controller

`PostApiController`

```java
@RequiredArgsConstructor
@RestController
@RequestMapping("/api")
public class PostApiController {
	private final PostService postService;

	// ë“±ë¡
	@PostMapping("/v1/post")
	public Long createPost(@RequestBody PostCreateRequestDto requestDto) {

		// TODO : ë‚˜ì¤‘ì— í—¤ë”ì˜ í† í°ì—ì„œ member id ë½‘ì•„ì˜¤ëŠ” ë¡œì§ í•„ìš”
		Long memberId = 1L; // ì§€ê¸ˆì€ ì„ì‹œë¡œ member idë¥¼ 1 ë¡œ ì„¤ì •

		return postService.createPost(requestDto, memberId);
	}

	// ì „ì²´ ì¡°íšŒ
	@GetMapping("/v1/post/")
	public List<PostReadResponseDto> findAllPosts() {
		return postService.findAllPosts();
	}

	// ë‹¨ê±´ ì¡°íšŒ
	@GetMapping("/v1/post/{postId}")
	public PostReadResponseDto findPost(@PathVariable("postId") Long postId) {
		return postService.findPost(postId);
	}

	// ìˆ˜ì •
	@PatchMapping("/v1/post/{postId}")
	public Long updatePost(@PathVariable("postId") Long postId, @RequestBody PostUpdateRequestDto requestDto) {

		Long memberId = 1L; // ì§€ê¸ˆì€ ì„ì‹œë¡œ member idë¥¼ 1 ë¡œ ì„¤ì •

		return postService.updatePost(requestDto, postId, memberId);
	}

	//ì‚­ì œ
	@DeleteMapping("/v1/post/{postId}")
	public Long deletePost(@PathVariable("postId") Long postId) {

		Long memberId = 1L; // ì§€ê¸ˆì€ ì„ì‹œë¡œ member idë¥¼ 1 ë¡œ ì„¤ì •

		return postService.deletePost(postId, memberId);
	}

}
```

- ê¶Œí•œ ì²´í¬ë¥¼ ìœ„í•´ memberId ë¥¼ ì„ì‹œë¡œ ì„¤ì •í•˜ê³  Service ë‹¨ì— ë„˜ê²¨ì£¼ì–´ì„œ ì²´í¬í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

# Service

`PostService`

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class PostService {

	private final PostRepository postRepository;
	private final CategoryRepository categoryRepository;
	private final MemberRepository memberRepository;
//	private final ModelMapper modelMapper;

	/**
	 * ê²Œì‹œê¸€ ë“±ë¡
	 */
	@Transactional
	public Long createPost(PostCreateRequestDto requestDto, Long memberId) {

		Category category = categoryRepository.findById(requestDto.getCategoryId())
				.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. id=" + requestDto.getCategoryId()));

		Member member = memberRepository.findById(memberId)
				.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤. id=" + memberId));

		Post post = Post.builder()
				.category(category)
				.seller(member)
				.title(requestDto.getTitle())
				.dealType(requestDto.getDealType())
				.description(requestDto.getDescription())
				.dealPlace(requestDto.getDealPlace())
				.price(requestDto.getPrice())
				.isPriceOffer(requestDto.getIsPriceOffer())
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		return postRepository.save(post).getId();
	}

	/**
	 * ê²Œì‹œê¸€ ì „ì²´ ì¡°íšŒ
	 */
	public List<PostReadResponseDto> findAllPosts() {
		List<Post> posts = postRepository.findAll();
		return posts.stream()
				.map(PostReadResponseDto::fromEntity)
				.collect(Collectors.toList());
	}

	/**
	 * ê²Œì‹œê¸€ ë‹¨ê±´ ì¡°íšŒ
	 */
	public PostReadResponseDto findPost(Long postId) {
		Post post =  postRepository.findById(postId)
				.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. id=" + postId));

		// return modelMapper.map(post, PostReadResponseDto.class);
		return PostReadResponseDto.fromEntity(post);
	}

	/**
	 * ê²Œì‹œê¸€ ìˆ˜ì •
	 */
	@Transactional
	public Long updatePost(PostUpdateRequestDto requestDto, Long postId, Long memberId) {
		Post post = postRepository.findById(postId)
				.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. id=" + postId));

		// ê²Œì‹œê¸€ ì‘ì„±ìì™€ ìˆ˜ì • ìš”ì²­ìê°€ ê°™ì€ì§€ í™•ì¸
		if (post.getSeller().getId() != memberId) {
			throw new IllegalArgumentException("ê²Œì‹œê¸€ ì‘ì„±ìì™€ ìˆ˜ì • ìš”ì²­ìê°€ ê°™ì§€ ì•ŠìŠµë‹ˆë‹¤.");
		}

		// requestDto.getCategoryId ê°€ ìˆì„ ë•Œ
		Category category = null;
		if (requestDto.getCategoryId() != null) {
			category = categoryRepository.findById(requestDto.getCategoryId())
					.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. id=" + requestDto.getCategoryId()));
		}

		post.setTitle(requestDto.getTitle());

		if (category != null) {
			post.setCategory(category);
		}

		post.setDealType(requestDto.getDealType());
		post.setDescription(requestDto.getDescription());
		post.setDealPlace(requestDto.getDealPlace());
		post.setPrice(requestDto.getPrice());
		post.setIsPriceOffer(requestDto.getIsPriceOffer());

		return postId;
	}

	/**
	 * ê²Œì‹œê¸€ ì‚­ì œ
	 */
	@Transactional
	public Long deletePost(Long postId, Long memberId) {
		Post post = postRepository.findById(postId)
				.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. id=" + postId));

		// ê²Œì‹œê¸€ ì‘ì„±ìì™€ ì‚­ì œ ìš”ì²­ìê°€ ê°™ì€ì§€ í™•ì¸
		if (post.getSeller().getId() != memberId) {
			throw new IllegalArgumentException("ê²Œì‹œê¸€ ì‘ì„±ìì™€ ì‚­ì œ ìš”ì²­ìê°€ ê°™ì§€ ì•ŠìŠµë‹ˆë‹¤.");
		}

		postRepository.delete(post);
		return postId;
	}

}
```

# Repository

repository ëŠ” ë³„ë„ì˜ ì»¤ìŠ¤í…€ë©”ìŠ¤ë”ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  JpaRepository ì—ì„œ ì§€ì›í•˜ëŠ” ë©”ì„œë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

```java
package com.ceos18.springboot.repository;

import com.ceos18.springboot.domain.entity.Post;
import org.springframework.data.jpa.repository.JpaRepository;

public interface PostRepository extends JpaRepository<Post, Long> {

}
```

# api í…ŒìŠ¤íŠ¸

í†µí•©í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë”°ë¡œ ì§œì§„ ì•Šì•˜ê³  swagger ìƒì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.

## post ìƒì„±

![Untitled 21](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/b401da9d-0056-4af1-a915-2af86374ff5b)

![Untitled 22](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/609e384e-ae02-4362-bcfa-4cc636e25235)

![Untitled 23](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/dc4fa73f-539f-42c1-aabb-f8e9274caa97)

## post ì „ì²´ ì¡°íšŒ


![Untitled 24](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/3ed57c5e-0155-4e67-af40-e760ae665105)

![Untitled 25](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/89914ad4-da64-483c-8136-928116c6ae1c)

```java
[
  {
    "id": 1,
    "category": {
      "id": 1,
      "name": "ì „ìê¸°ê¸°"
    },
    "seller": {
      "id": 1,
      "nickName": null
    },
    "title": "t1",
    "dealType": "SELL",
    "description": "string",
    "dealPlace": "string",
    "price": 0,
    "isPriceOffer": true,
    "status": "SALE",
    "likedCount": 0,
    "viewCount": 0,
    "pullupAt": null
  },
  {
    "id": 2,
    "category": {
      "id": 1,
      "name": "ì „ìê¸°ê¸°"
    },
    "seller": {
      "id": 1,
      "nickName": null
    },
    "title": "t2",
    "dealType": "SELL",
    "description": "string",
    "dealPlace": "string",
    "price": 0,
    "isPriceOffer": true,
    "status": "SALE",
    "likedCount": 0,
    "viewCount": 0,
    "pullupAt": null
  }
]
```

## post ë‹¨ê±´ ì¡°íšŒ

![Untitled 26](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/dbb1132d-0a1a-4856-8e27-b132e3110182)

![Untitled 27](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/57804ff0-8c12-4f63-b158-fc4d93069102)

## post ìˆ˜ì •

![Untitled 28](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/d2f735c8-dc8d-4e48-a57c-dfd6fdbbc809)

title ì„ ìˆ˜ì •í•´ë³´ê² ìŠµë‹ˆë‹¤

![Untitled 29](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/81abe3ec-736d-4b34-a1b7-ff8afdbe72e6)

## post ì‚­ì œ

![Untitled 30](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/ebe110fc-19aa-4fad-b689-965d6ae4c4a8)

![Untitled 31](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/776af15d-7ea7-408f-b47d-a2a951e14b0f)

---

# ëŠë‚€ ì  ë° ê³ ë¯¼

- ì§€ì—°ë¡œë”© ì„¸íŒ… ë° N+1 ë¬¸ì œ í•´ê²°í•´ì•¼ í•©ë‹ˆë‹¤
- controller ì—ì„œ service ë‹¨ì— ë°ì´í„°ë¥¼ ë„˜ê²¨ì¤„ ë•Œ ì–´ë–»ê²Œ í•´ì•¼ ë” ê¹”ë”í•˜ê²Œ ë„˜ê²¨ì¤„ ìˆ˜ ìˆì„ ì§€ ê³ ë¯¼ì…ë‹ˆë‹¤.
- service ë‹¨ì—ì„œ ì¸í„°í˜ì´ìŠ¤ì™€ impl íŒ¨í„´ ì‚¬ìš© ì‹œ ì¥ë‹¨ì ê³¼ í”„ë¡œì íŠ¸ì—ì„œ ì ìš© ì—¬ë¶€ì— ëŒ€í•œ ê³ ë¯¼
- vo ë¥¼ ì´ë ‡ê²Œ ì“°ëŠ”ê²Œ ë§ëŠ”ê±´ì§€ì— ëŒ€í•œ ì˜ë¬¸
- ì»¤ë§¨ë“œ, ì¿¼ë¦¬ë¥¼ ë¶„ë¦¬í•˜ëŠ” íŒ¨í„´ ë˜í•œ ìš°ë¦¬ ìˆ˜ì¤€ í”„ë¡œì íŠ¸ì—ì„œ ìœ ì˜ë¯¸í•œ ì¥ì ì´ ìˆì„ê¹Œ í•˜ëŠ” ê³ ë¯¼