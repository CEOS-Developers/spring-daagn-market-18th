# ë‹¹ê·¼ë§ˆì¼“ í´ë¡ 

---

# ğŸŒ±Â 2ì£¼ì°¨ ë¯¸ì…˜

## 1ï¸âƒ£Â ë‹¹ê·¼ ë§ˆì¼“ì˜ DBë¥¼ ëª¨ë¸ë§í•´ìš”

- ë¬¼ê±´ ì˜¬ë¦¬ê¸°
- ë¬¼ê±´ ì°¾ê¸°
- 1:1 ì±„íŒ…
- êµ¬ë§¤ í™•ì •
- ë¦¬ë·°(ì˜¨ë„)

[ë‹¹ê·¼ë§ˆì¼“ ëª¨ë¸ë§](https://www.erdcloud.com/d/za7jEwYXR2iz545rX)

![Untitled](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/70761da6-0ecf-4e9c-9cd4-818511cd2586)

DB ëª¨ë¸ë§

| ì—”í‹°í‹°ëª…(ë…¼ë¦¬) | í…Œì´ë¸”ëª…(ë¬¼ë¦¬) | ì„¤ëª… |
| --- | --- | --- |
| íšŒì› | members | íšŒì› ì •ë³´ë¥¼ ì €ì¥ |
| ê²Œì‹œê¸€ | posts | íšŒì›ì€ ì—¬ëŸ¬ ê°œì˜ ê²Œì‹œê¸€(ì¤‘ê³ ë¬¼í’ˆ)ì„ ì˜¬ë¦´ ìˆ˜ ìˆìŒ |
| ê²Œì‹œê¸€ ì´ë¯¸ì§€ | item_images | ê²Œì‹œê¸€ì˜ ì´ë¯¸ì§€ ë§í¬ë¥¼ ì €ì¥ |
| ì¹´í…Œê³ ë¦¬ | categories | ê²Œì‹œê¸€ì˜ ì¹´í…Œê³ ë¦¬ ë²”ì£¼ |
| ê±°ë˜ ì™„ë£Œ | completed_deals | ì™„ë£Œëœ ê±°ë˜ |
| ê±°ë˜ í›„ê¸° | deal_reviews | ì™„ë£Œëœ ê±°ë˜ì˜ ê±°ë˜ í›„ê¸° |
| ì±„íŒ…ë°© | chat_rooms | ì¤‘ê³ ë¬¼ê±´ ê²Œì‹œê¸€ì— ìƒì„±ë˜ëŠ” ì±„íŒ…ë°© |
| íšŒì›-ì±„íŒ…ë°© (ì—°ê²°í…Œì´ë¸”) | members_chatrooms | íšŒì› ê³¼ ì±„íŒ…ë°© ì„ ë§¤í•‘í•˜ëŠ” í…Œì´ë¸” |
| ì±„íŒ… ë©”ì‹œì§€ | chat_messages | ì±„íŒ… ë°œì‹ ìì™€ ë‚´ìš©ì„ ì €ì¥ |

### ëª¨ë¸ë§ ê³¼ì •ì—ì„œ í•œ ê³ ë¯¼

**1. FK ë¥¼ ê¼­ ë‹¤ ì¨ì•¼í• ê¹Œ?**  

   FK ì“¸ ë•Œ ì¥ì  : ë°ì´í„° ë¬´ê²°ì„±, join ì„±ëŠ¥

   FK ì•ˆ ì“¸ ë•Œ ì¥ì  : ê°œë°œ í¸ì˜ì„± í–¥ìƒ, í™•ì¥ì— ìœ ë¦¬, ìˆ˜ë™ìœ¼ë¡œ DB ì‘ì—…ì´ í¸ë¦¬, ì§„ì§œ í˜¹ì‹œë„ ëª¨ë¥¼ ëŒ€ì°¸ì‚¬ ë°©ì§€(?)

   ( + FK ë¥¼ ì•ˆ ì“´ë‹¤ë©´ join ì„±ëŠ¥ì„ ìœ„í•´ ì¸ë±ìŠ¤ ì‚¬ìš©ì´ ê±°ì˜ í•„ìˆ˜ì  )

   ê³¼ì œ ëª¨ë¸ë§ì—ì„œëŠ” FK ë¥¼ ì ìš©í–ˆìŒ


**2. ì‹ë³„ vs ë¹„ì‹ë³„**

   ìœ ì—°í•œ ì„¤ê³„ë¥¼ ìœ„í•´ ë¹„ì‹ë³„ ê´€ê³„ë¥¼ ì„ í˜¸í•¨


**3. ë‹¹ê·¼ë§ˆì¼“ì˜ ë¡œê·¸ì¸ ë°©ì‹ì— ë”°ë¥¸ íšŒì› ì—”í‹°í‹° ì„¤ê³„**

  ![Untitled 1](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/a7aa3e79-37fd-41ce-afa0-00029569322b)

   íšŒì›ê°€ì…ì„ í•  ë•Œ ì•„ì´ë””, íŒ¨ìŠ¤ì›Œë“œ ë°©ì‹ì´ ì•„ë‹Œ íœ´ëŒ€í° ë²ˆí˜¸ë¡œ ì „ì†¡ëœ ì¸ì¦ ì½”ë“œë¥¼ ì¸ì¦í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ íšŒì›ê°€ì…ì´ ì™„ë£Œëœë‹¤. ì•„ì´ë””ê°€ íœ´ëŒ€í° ë²ˆí˜¸ê°€ ë˜ëŠ”ì…ˆì´ê³  íŒ¨ìŠ¤ì›Œë“œëŠ” ë”°ë¡œ ì—†ë‹¤.



**4. ì—”í‹°í‹° ë„¤ì´ë° : ì¤‘ê³ ë¬¼ê±´(items,product..) vs ê²Œì‹œê¸€(post..)**

   ì¼ë°˜ì ì¸ ì´ì»¤ë¨¸ìŠ¤ì™€ ë‹¤ë¥´ê²Œ ì¤‘ê³ ê±°ë˜ëŠ” **ë¬¼í’ˆ**ì´ **ê²Œì‹œê¸€**ì˜ ì—­í• ë„ ê²¸í•œë‹¤.

   ë„¤ì´ë°ì„ ì–´ë–»ê²Œ í• ê¹Œ ê³ ë¯¼ì„ í–ˆëŠ”ë°, **ê²Œì‹œê¸€(posts)** ë¡œ ê²°ì •í•¨

   ê·¼ê±°

    - ë‹¹ê·¼ ì„œë¹„ìŠ¤ ë‚´ ì—ì„œ ê¸€ ì“°ê¸° ë²„íŠ¼ì„ í´ë¦­í•œ ë’¤ ì¤‘ê³ ë¬¼í’ˆì„ ì˜¬ë¦¬ëŠ” í¼ì´ ëœ¸
    - ë¬¼í’ˆì— ëŒ€í•œ ì±„íŒ…ë°© ë³´ë‹¤ëŠ” ê²Œì‹œê¸€ì— ëŒ€í•œ ì±„íŒ…ë°©ì´ ë” ìì—°ìŠ¤ëŸ½ë‹¤ê³  ìƒê°

<br>

**5. ê±°ë˜ ì™„ë£Œ ì™€ ê±°ë˜ í›„ê¸°**

   ![Untitled 2](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/a7a69063-95f5-4d16-87e5-20c4ac754776)

   ê±°ë˜ ì™„ë£Œ ì²˜ë¦¬ë¥¼ ìœ„í•´ items í…Œì´ë¸”ì— íŒë§¤ìì™€ êµ¬ë§¤ì ì»¬ëŸ¼ì„ ë‘˜ ë‹¤ ë†“ì„ ìˆ˜ ë„ ìˆê² ì§€ë§Œ, ê±°ë˜ ì™„ë£Œ í…Œì´ë¸”ì„ ë³„ë„ë¡œ ë¶„ë¦¬í–ˆìŒ <br><br>

   ê·¼ê±°

    - nullable í•œ FK ë¥¼ ìµœëŒ€í•œ ì¤„ì´ê³  ì‹¶ì—ˆìŒ (êµ¬ë§¤ì ID)
    - ê±°ë˜ ë¼ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ê±°ë˜ ì™„ë£ŒëŠ” í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ì´ë¯€ë¡œ ë³„ë„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ ê´œì°®ê² ë‹¤ê³  ìƒê°í•¨

<br>
   íšŒì›ì˜ ê²Œì‹œê¸€ ì¡°íšŒ, íšŒì›ì˜ ê±°ë˜ ì™„ë£Œ ì¡°íšŒ, íšŒì›ì˜ ê±°ë˜ í›„ê¸° ì¡°íšŒ ì˜ ì„±ëŠ¥ì„ ìœ„í•´ ê° í…Œì´ë¸”ì— member ë¥¼ ì°¸ì¡°í•œ FK ë¥¼ ë‘ 

<br>


**6. íšŒì›ì˜ ì±„íŒ…ë°©ì„ ì¡°íšŒí•  ë•Œì˜ ì„±ëŠ¥ ê³ ë¯¼**

- case 1) chat_room í…Œì´ë¸”ì— ê²Œì‹œê¸€(posts) ì™€ íšŒì›(members) ì„ ì°¸ì¡°í•˜ëŠ” FKê°€ ì¡´ì¬

  ![Untitled 3](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/eef35ca7-9d2a-49e4-8799-65bd14bf49f9)


- ë‚´ê°€ íŒë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ posts â†’ chat_rooms : ì‚¼ì¤‘ì¡°ì¸ or `whereâ€¦in` ì‚¬ìš©

- ë‚´ê°€ êµ¬ë§¤(í¬ë§)ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ chat_rooms : ì¡°ì¸


- case 2) chat_room í…Œì´ë¸”ì— íŒë§¤ì(seller_id) ì»¬ëŸ¼ì„ FK ë¡œ ì¶”ê°€

  ![Untitled 4](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ea59e70b-4b96-4d56-8cc7-b9eb97bc903f)


chat_room í…Œì´ë¸”ì— íŒë§¤ì id (member ì°¸ì¡° FK) ë¥¼ ë‘ëŠ” ì—­ì •ê·œí™”

- ë‚´ê°€ íŒë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ chat_rooms : ì¡°ì¸

- ë‚´ê°€ êµ¬ë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ chat_rooms : ì¡°ì¸


â‡’ posts í…Œì´ë¸”ê³¼ ë¬´ê´€í•´ì§€ë¯€ë¡œ case 1 ë³´ë‹¤ ë” ê°œì„ ë¨

- case 3) many to many ì‚¬ì´ì— join table ì¶”ê°€

  ![Untitled 5](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ba099f93-b8ff-4dbe-aac4-0d154e38a901)


- ë‚´ê°€ íŒë§¤ì,êµ¬ë§¤ìì¸ ì±„íŒ…ë°© ì¡°íšŒ

  members â†’ members_chatrooms â†’ chat_rooms : ì‚¼ì¤‘ì¡°ì¸


ì¥ì 

- íŒë§¤ì, êµ¬ë§¤ìì— ëŒ€í•œ ë¡œì§ ë¶„ê¸°ê°€ í•„ìš” ì—†ì–´ì§
- ì±„íŒ…ë°© ì— ëŒ€í•œ í™•ì¥ì„±ë„ ì¦ê°€í•´ì„œ ì´ ë°©ì‹ì„ ìµœì¢…ì ìœ¼ë¡œ ì„ íƒ

  â‡’ 1:1 ì±„íŒ…ì´ ì•„ë‹Œ ë‹¨ì²´ ì±„íŒ…ë„ ì‰½ê²Œ êµ¬í˜„ ê°€ëŠ¥


### í…Œì´ë¸” ìƒì„¸ ì„¤ëª…

ëª¨ë“  í…Œì´ë¸”ì— createdDate ì™€ updatedDate ì»¬ëŸ¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤ (ERD ìƒì—ëŠ” ìƒëµë¨)
    


- íšŒì› (members)

  ![Untitled 6](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/785e117c-4465-4234-87a1-02c3f91397a7)


- íšŒì›íƒˆí‡´ì—¬ë¶€ : íƒˆí‡´ ì‹œ, DELETE ê°€ ì•„ë‹Œ UPDATE ë¡œ ë°ì´í„° ìœ ì§€ ë° ì‚¬ê¸° ìœ ì € ë°©ì§€
- ì§€ì—­ : ê¹Šê²Œ ë“¤ì–´ê°€ë©´ ê³ ë ¤í•  ì‚¬í•­ì´ ë„ˆë¬´ ë§ì•„ì„œ ìš°ì„ ì€ ë‹¨ìˆœ string ìœ¼ë¡œ ì²˜ë¦¬
  

- ê²Œì‹œê¸€ (posts)

  ![Untitled 7](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/f80565c5-5100-4787-ab05-eb8f6055a4a4)
  

- ê²Œì‹œê¸€ ì´ë¯¸ì§€ (post_images)

  ![Untitled 8](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ca95419f-0c42-463a-82cb-596e1df2c7ec)
  

- ì¹´í…Œê³ ë¦¬ (categories)

  ![Untitled 9](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/31e71156-24e0-4638-b99c-9e35f1d1ee6b)
  

- ê±°ë˜ ì™„ë£Œ (completed_deals)

  ![Untitled 10](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/b422bd45-0e30-4546-8412-1ff94a4ffe9c)
  

- ê±°ë˜ í›„ê¸° (deal_reviews)

  <img width="318" alt="Untitled 11" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/31cf03d8-8ccd-4613-ab6a-68f554f2cc6d">
  

- ì±„íŒ…ë°© (chat_rooms)

  <img width="227" alt="Untitled 12" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/78d0ce8d-bb05-4ace-92ce-6d4289b32f7e">
  

- íšŒì›-ì±„íŒ…ë°© (members_chatrooms)

  <img width="267" alt="Untitled 13" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/e95b1fd6-4ad0-4496-bba8-99e386203f36">
  

- ì±„íŒ… ë©”ì‹œì§€ (chat_messages)

  <img width="302" alt="Untitled 14" src="https://github.com/itsme-shawn/itsme-shawn/assets/48885608/a63073e1-d12d-4f36-87df-4d2c200a3290">


### ì „ì²´ ì—°ê´€ ê´€ê³„

![Untitled 15](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/ff9c4d87-c258-479e-87ed-2a1e0dbb4126)

---

## 2ï¸âƒ£Â Repository ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ìš”

Post Entity ì—ëŒ€í•œ Repository ë¥¼ ë§Œë“¤ê³  @DataJpaTest ë¥¼ í†µí•´ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì

```java
package com.ceos18.springboot.repository;

import com.ceos18.springboot.domain.entity.Category;
import com.ceos18.springboot.domain.entity.Member;
import com.ceos18.springboot.domain.entity.Post;
import com.ceos18.springboot.domain.entity.enums.DealType;
import com.ceos18.springboot.domain.entity.enums.PostStatus;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.boot.test.autoconfigure.orm.jpa.TestEntityManager;

import java.math.BigDecimal;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class PostRepositoryTest {

	@Autowired
	private TestEntityManager em;

	@Autowired
	private PostRepository postRepository;

	@Test
	public void testSaveAndFind() {
		// Given

		Category category = Category.builder()
				.name("ë„ì„œ")
				.build();

		Member member = Member.builder()
				.phoneNumber("010-1111-2222")
				.isWithdrawal(false)
				.mannerRating(BigDecimal.valueOf(36.5))
				.region("ì„œìš¸")
				.build();

		em.persist(category);
		em.persist(member);

		Post post1 = Post.builder()
				.category(category)
				.seller(member)
				.title("title")
				.dealType(DealType.SELL)
				.isPriceOffer(true)
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		Post post2 = Post.builder()
				.category(category)
				.seller(member)
				.title("title")
				.dealType(DealType.SELL)
				.isPriceOffer(true)
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		Post post3 = Post.builder()
				.category(category)
				.seller(member)
				.title("title")
				.dealType(DealType.SELL)
				.isPriceOffer(true)
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		// When
		em.persist(post1);
		em.persist(post2);
		em.persist(post3);

		List<Post> posts = postRepository.findAll();

		// Then
		assertThat(posts).hasSize(3);
		assertThat(posts).contains(post1, post2, post3);
	}
}
```

- Post Entity ëŠ” Category ì™€ Member ë¥¼ ì°¸ì¡°í•˜ê³  ìˆì–´ì„œ Category ì™€ Member ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë¨¼ì € ìƒì„±í•œ ë’¤ persist í•´ì¤˜ì•¼ í•œë‹¤.
  <br><br>
- í…ŒìŠ¤íŠ¸ í†µê³¼

    ![Untitled 16](https://github.com/itsme-shawn/itsme-shawn/assets/48885608/122b2edd-f297-4e2c-b0b9-b2a18fb91891)

## TroubleShooting

- java springboot ì—ì„œëŠ” íŒ¨í‚¤ì§€ëª…ìœ¼ë¡œ enum ì´ ì•ˆ ëœë‹¤
- ì •í™•í•œ ì‹¤ìˆ˜ ê³„ì‚°ì´ í•„ìš”í•  ë•Œì—ëŠ” float, double ëŒ€ì‹  BigDecimal ì„ ì‚¬ìš©í•˜ì
- [https://codingdog.tistory.com/entry/mysql-decimal-vs-double-ê³ ì •-ì†Œìˆ˜ì ê³¼-ë¶€ë™-ì†Œìˆ˜ì ](https://codingdog.tistory.com/entry/mysql-decimal-vs-double-%EA%B3%A0%EC%A0%95-%EC%86%8C%EC%88%98%EC%A0%90%EA%B3%BC-%EB%B6%80%EB%8F%99-%EC%86%8C%EC%88%98%EC%A0%90)

---

# ğŸŒ±3ì£¼ì°¨ ë¯¸ì…˜

# í”„ë¡œì íŠ¸ íŒ¨í‚¤ì§€ êµ¬ì¡°

![Untitled 17](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/6dc9be1f-9b94-4e58-953f-0ec5d8de0224)

Post (ê²Œì‹œê¸€) ë„ë©”ì¸ì— ëŒ€í•´ CRUD ë¥¼ ë§Œë“¤ì–´ë´…ì‹œë‹¤.

í˜„ì¬ ì œ Post ì—”í‹°í‹°ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```java
package com.ceos18.springboot.domain.entity;

import com.ceos18.springboot.domain.entity.base.BaseTimeEntity;
import com.ceos18.springboot.domain.entity.enums.DealType;
import com.ceos18.springboot.domain.entity.enums.PostStatus;
import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Getter
@Setter
@Table(name = "posts")
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Post extends BaseTimeEntity {
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id; // PK

	@ManyToOne
	@JoinColumn(name = "category_id", nullable = false)
	private Category category;

	@ManyToOne
	@JoinColumn(name = "seller_id", nullable = false)
	private Member seller;

	@Column(name = "title", nullable = false)
	private String title;

	@Column(name = "deal_type", nullable = false)
	@Enumerated(EnumType.STRING)
	private DealType dealType;

	@Column(name = "description")
	private String description;

	@Column(name = "deal_place")
	private String dealPlace;

	@Column(name = "price")
	private BigDecimal price;

	@Column(name = "is_price_offer", nullable = false)
	private Boolean isPriceOffer;

	@Column(name = "status", nullable = false)
	@Enumerated(EnumType.STRING)
	private PostStatus status;

	@Column(name = "liked_count", nullable = false)
	private int likedCount;

	@Column(name = "view_count", nullable = false)
	private int viewCount;

	@Column(name = "pullup_at")
	private LocalDateTime pullupAt;

}
```

Post ëŠ” Category ì™€ Member(seller) ë¥¼ ì°¸ì¡°í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì‚¬ì „ì— Category ì™€ Member ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ì„ì‹œë¡œ InitDb ë¼ëŠ” í´ë˜ìŠ¤ì—ì„œ ìŠ¤í”„ë§ì´ êµ¬ë™ë  ë•Œ Category ì™€ Member DB ë¥¼ ë§Œë“¤ì–´ì£¼ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

`InitDb`

```java
package com.ceos18.springboot;

import com.ceos18.springboot.domain.entity.Category;
import com.ceos18.springboot.domain.entity.Member;
import com.ceos18.springboot.repository.CategoryRepository;
import com.ceos18.springboot.repository.MemberRepository;
import jakarta.annotation.PostConstruct;
import jakarta.persistence.EntityManager;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

@Component
@RequiredArgsConstructor
public class InitDb {

	private final InitService initService;

	@PostConstruct
	public void init() {
		initService.dbInit1();
	}

	@Component
	@Transactional
	@RequiredArgsConstructor
	static class InitService {

		private final MemberRepository memberRepository;
		private final CategoryRepository categoryRepository;

		public void dbInit1() {
			System.out.println("Init1" + this.getClass());

			Member member = new Member();
			member.setPhoneNumber("010-1111-2222");
			member.setEmail("abc@gmail.com");

			memberRepository.save(member);

			Category category = new Category();
			category.setName("ì „ìê¸°ê¸°");

			categoryRepository.save(category);
		}

	}
}
```

Category ì™€ Member í•˜ë‚˜ì”©ì„ save í•´ì¤ë‹ˆë‹¤.

![Untitled 18](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/7fd61359-0a75-4713-be2b-19d424d6dbde)

![Untitled 19](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/17955e5a-aac5-4f2e-b0f0-91a249b45af4)



# API ì„¤ê³„

![Untitled 20](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/c3309bb8-b973-46ae-b252-916161fb0ea3)

## post ìƒì„±

**POST : /api/v1/post**

- parameter : ì—†ìŒ
- request body

```java
{
  "title": "string",
  "categoryId": 0,
  "dealType": "SELL",
  "description": "string",
  "dealPlace": "string",
  "price": 0,
  "isPriceOffer": true
}
```

- ì„±ê³µ response : post ì˜ id ë¥¼ ë°˜í™˜

```java
1
```

## post ì „ì²´ ì¡°íšŒ

**GET : /api/v1/post**

- parameter : ì—†ìŒ
- request body : ì—†ìŒ

- ì„±ê³µ response

```java
[
  {
    "id": 0,
    "category": {
      "id": 0,
      "name": "string"
    },
    "seller": {
      "id": 0,
      "nickName": "string"
    },
    "title": "string",
    "dealType": "SELL",
    "description": "string",
    "dealPlace": "string",
    "price": 0,
    "isPriceOffer": true,
    "status": "SALE",
    "likedCount": 0,
    "viewCount": 0,
    "pullupAt": "2023-10-07T14:29:51.516Z"
  }
]
```

## post ë‹¨ê±´ ì¡°íšŒ

**GET : /api/v1/post/{postId}**

- parameter : postId
- request body : ì—†ìŒ

- ì„±ê³µ response

```java
{
  "id": 0,
  "category": {
    "id": 0,
    "name": "string"
  },
  "seller": {
    "id": 0,
    "nickName": "string"
  },
  "title": "string",
  "dealType": "SELL",
  "description": "string",
  "dealPlace": "string",
  "price": 0,
  "isPriceOffer": true,
  "status": "SALE",
  "likedCount": 0,
  "viewCount": 0,
  "pullupAt": "2023-10-07T14:32:25.278Z"
}
```

## post ìˆ˜ì •

**PATCH : /api/v1/post/{postId}**

- parameter : `postId`
- request body

    ```java
    {
      "title": "string",
      "categoryId": 0,
      "dealType": "SELL",
      "description": "string",
      "dealPlace": "string",
      "price": 0,
      "isPriceOffer": true
    }
    
    ```


- ì„±ê³µ response : post ì˜ id ë¥¼ ë°˜í™˜

```java
1
```

## post ì‚­ì œ

**DELETE : /api/v1/post/{postId}**

- parameter : `postId`
- request body : ì—†ìŒ

- ì„±ê³µ response : post ì˜ id ë¥¼ ë°˜í™˜

```java
1
```

# Dto ìƒì„±

## request dto

`PostCreateRequestDto`

```java
@Getter
@NoArgsConstructor
public class PostCreateRequestDto {

	private String title;
	private Long categoryId;
	private DealType dealType;
	private String description;
	private String dealPlace;
	private BigDecimal price;
	private Boolean isPriceOffer;

}
```

- Post ë¥¼ ìƒì„±í•  ë•Œ, í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œ ë„˜ì–´ì˜¬ ê°’ì„ ì •ì˜í•©ë‹ˆë‹¤.

`PostUpdateRequestDto`

```java
@Getter
@NoArgsConstructor
public class PostUpdateRequestDto {
	private String title;
	private Long categoryId;
	private DealType dealType;
	private String description;
	private String dealPlace;
	private BigDecimal price;
	private Boolean isPriceOffer;
}
```

- Post ë¥¼ ìˆ˜ì •í•  ë•Œ, í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œ ë„˜ì–´ì˜¬ ê°’ì„ ì •ì˜í•©ë‹ˆë‹¤.

## response dto

```java
@Getter
@Setter
public class PostReadResponseDto {
	private Long id;
	private CategoryVo category; // ì—°ê´€ê´€ê³„
	private MemberVo seller; // // ì—°ê´€ê´€ê³„
	private String title;
	private DealType dealType;
	private String description;
	private String dealPlace;
	private BigDecimal price;
	private Boolean isPriceOffer;
	private PostStatus status;
	private int likedCount;
	private int viewCount;
	private LocalDateTime pullupAt;

	public static PostReadResponseDto fromEntity(Post post) {
		PostReadResponseDto dto = new PostReadResponseDto();
		dto.setId(post.getId());
		dto.setCategory(CategoryVo.fromEntity(post.getCategory()));
		dto.setSeller(MemberVo.fromEntity(post.getSeller()));
		dto.setTitle(post.getTitle());
		dto.setDealType(post.getDealType());
		dto.setDescription(post.getDescription());
		dto.setDealPlace(post.getDealPlace());
		dto.setPrice(post.getPrice());
		dto.setIsPriceOffer(post.getIsPriceOffer());
		dto.setStatus(post.getStatus());
		dto.setLikedCount(post.getLikedCount());
		dto.setViewCount(post.getViewCount());
		dto.setPullupAt(post.getPullupAt());
		return dto;
	}

}
```

dto ì—ì„œ response ê°’ì„ ì•„ë˜ì²˜ëŸ¼ ì£¼ê¸° ìœ„í•´ ë‚´ë¶€ì ìœ¼ë¡œ CategoryVo ì™€ MemberVo ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

```java
{
  "id": 0,
  "category": {
    "id": 0,
    "name": "string"
  },
  "seller": {
    "id": 0,
    "nickName": "string"
  },
  "title": "string",
  "dealType": "SELL",
  "description": "string",
  "dealPlace": "string",
  "price": 0,
  "isPriceOffer": true,
  "status": "SALE",
  "likedCount": 0,
  "viewCount": 0,
  "pullupAt": "2023-10-07T14:32:25.278Z"
}
```

`CategoryVo`

```java
@Getter
@Setter
public class CategoryVo {
	private Long id;
	private String name;

	public static CategoryVo fromEntity(Category category) {
		CategoryVo categoryVo = new CategoryVo();
		categoryVo.setId(category.getId());
		categoryVo.setName(category.getName());
		return categoryVo;
	}

	public Category toEntity() {
		Category category = new Category();
		category.setId(this.id);
		category.setName(this.name);
		return category;
	}
}
```

`MemberVo`

```java
@Getter
@Setter
public class MemberVo {
	private Long id;
	private String nickName;

	public static MemberVo fromEntity(Member member) {
		MemberVo memberVo = new MemberVo();
		memberVo.setId(member.getId());
		memberVo.setNickName(member.getNickName());
		return memberVo;
	}

	public Member toEntity() {
		Member member = new Member();
		member.setId(this.id);
		member.setNickName(this.nickName);
		return member;
	}
}
```

# Controller

`PostApiController`

```java
@RequiredArgsConstructor
@RestController
@RequestMapping("/api")
public class PostApiController {
	private final PostService postService;

	// ë“±ë¡
	@PostMapping("/v1/post")
	public Long createPost(@RequestBody PostCreateRequestDto requestDto) {

		// TODO : ë‚˜ì¤‘ì— í—¤ë”ì˜ í† í°ì—ì„œ member id ë½‘ì•„ì˜¤ëŠ” ë¡œì§ í•„ìš”
		Long memberId = 1L; // ì§€ê¸ˆì€ ì„ì‹œë¡œ member idë¥¼ 1 ë¡œ ì„¤ì •

		return postService.createPost(requestDto, memberId);
	}

	// ì „ì²´ ì¡°íšŒ
	@GetMapping("/v1/post/")
	public List<PostReadResponseDto> findAllPosts() {
		return postService.findAllPosts();
	}

	// ë‹¨ê±´ ì¡°íšŒ
	@GetMapping("/v1/post/{postId}")
	public PostReadResponseDto findPost(@PathVariable("postId") Long postId) {
		return postService.findPost(postId);
	}

	// ìˆ˜ì •
	@PatchMapping("/v1/post/{postId}")
	public Long updatePost(@PathVariable("postId") Long postId, @RequestBody PostUpdateRequestDto requestDto) {

		Long memberId = 1L; // ì§€ê¸ˆì€ ì„ì‹œë¡œ member idë¥¼ 1 ë¡œ ì„¤ì •

		return postService.updatePost(requestDto, postId, memberId);
	}

	//ì‚­ì œ
	@DeleteMapping("/v1/post/{postId}")
	public Long deletePost(@PathVariable("postId") Long postId) {

		Long memberId = 1L; // ì§€ê¸ˆì€ ì„ì‹œë¡œ member idë¥¼ 1 ë¡œ ì„¤ì •

		return postService.deletePost(postId, memberId);
	}

}
```

- ê¶Œí•œ ì²´í¬ë¥¼ ìœ„í•´ memberId ë¥¼ ì„ì‹œë¡œ ì„¤ì •í•˜ê³  Service ë‹¨ì— ë„˜ê²¨ì£¼ì–´ì„œ ì²´í¬í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

# Service

`PostService`

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class PostService {

	private final PostRepository postRepository;
	private final CategoryRepository categoryRepository;
	private final MemberRepository memberRepository;
//	private final ModelMapper modelMapper;

	/**
	 * ê²Œì‹œê¸€ ë“±ë¡
	 */
	@Transactional
	public Long createPost(PostCreateRequestDto requestDto, Long memberId) {

		Category category = categoryRepository.findById(requestDto.getCategoryId())
				.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. id=" + requestDto.getCategoryId()));

		Member member = memberRepository.findById(memberId)
				.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤. id=" + memberId));

		Post post = Post.builder()
				.category(category)
				.seller(member)
				.title(requestDto.getTitle())
				.dealType(requestDto.getDealType())
				.description(requestDto.getDescription())
				.dealPlace(requestDto.getDealPlace())
				.price(requestDto.getPrice())
				.isPriceOffer(requestDto.getIsPriceOffer())
				.status(PostStatus.SALE)
				.likedCount(0)
				.viewCount(0)
				.build();

		return postRepository.save(post).getId();
	}

	/**
	 * ê²Œì‹œê¸€ ì „ì²´ ì¡°íšŒ
	 */
	public List<PostReadResponseDto> findAllPosts() {
		List<Post> posts = postRepository.findAll();
		return posts.stream()
				.map(PostReadResponseDto::fromEntity)
				.collect(Collectors.toList());
	}

	/**
	 * ê²Œì‹œê¸€ ë‹¨ê±´ ì¡°íšŒ
	 */
	public PostReadResponseDto findPost(Long postId) {
		Post post =  postRepository.findById(postId)
				.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. id=" + postId));

		// return modelMapper.map(post, PostReadResponseDto.class);
		return PostReadResponseDto.fromEntity(post);
	}

	/**
	 * ê²Œì‹œê¸€ ìˆ˜ì •
	 */
	@Transactional
	public Long updatePost(PostUpdateRequestDto requestDto, Long postId, Long memberId) {
		Post post = postRepository.findById(postId)
				.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. id=" + postId));

		// ê²Œì‹œê¸€ ì‘ì„±ìì™€ ìˆ˜ì • ìš”ì²­ìê°€ ê°™ì€ì§€ í™•ì¸
		if (post.getSeller().getId() != memberId) {
			throw new IllegalArgumentException("ê²Œì‹œê¸€ ì‘ì„±ìì™€ ìˆ˜ì • ìš”ì²­ìê°€ ê°™ì§€ ì•ŠìŠµë‹ˆë‹¤.");
		}

		// requestDto.getCategoryId ê°€ ìˆì„ ë•Œ
		Category category = null;
		if (requestDto.getCategoryId() != null) {
			category = categoryRepository.findById(requestDto.getCategoryId())
					.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. id=" + requestDto.getCategoryId()));
		}

		post.setTitle(requestDto.getTitle());

		if (category != null) {
			post.setCategory(category);
		}

		post.setDealType(requestDto.getDealType());
		post.setDescription(requestDto.getDescription());
		post.setDealPlace(requestDto.getDealPlace());
		post.setPrice(requestDto.getPrice());
		post.setIsPriceOffer(requestDto.getIsPriceOffer());

		return postId;
	}

	/**
	 * ê²Œì‹œê¸€ ì‚­ì œ
	 */
	@Transactional
	public Long deletePost(Long postId, Long memberId) {
		Post post = postRepository.findById(postId)
				.orElseThrow(() -> new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. id=" + postId));

		// ê²Œì‹œê¸€ ì‘ì„±ìì™€ ì‚­ì œ ìš”ì²­ìê°€ ê°™ì€ì§€ í™•ì¸
		if (post.getSeller().getId() != memberId) {
			throw new IllegalArgumentException("ê²Œì‹œê¸€ ì‘ì„±ìì™€ ì‚­ì œ ìš”ì²­ìê°€ ê°™ì§€ ì•ŠìŠµë‹ˆë‹¤.");
		}

		postRepository.delete(post);
		return postId;
	}

}
```

# Repository

repository ëŠ” ë³„ë„ì˜ ì»¤ìŠ¤í…€ë©”ìŠ¤ë”ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  JpaRepository ì—ì„œ ì§€ì›í•˜ëŠ” ë©”ì„œë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

```java
package com.ceos18.springboot.repository;

import com.ceos18.springboot.domain.entity.Post;
import org.springframework.data.jpa.repository.JpaRepository;

public interface PostRepository extends JpaRepository<Post, Long> {

}
```

# api í…ŒìŠ¤íŠ¸

í†µí•©í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë”°ë¡œ ì§œì§„ ì•Šì•˜ê³  swagger ìƒì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.

## post ìƒì„±

![Untitled 21](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/b401da9d-0056-4af1-a915-2af86374ff5b)

![Untitled 22](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/609e384e-ae02-4362-bcfa-4cc636e25235)

![Untitled 23](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/dc4fa73f-539f-42c1-aabb-f8e9274caa97)

## post ì „ì²´ ì¡°íšŒ


![Untitled 24](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/3ed57c5e-0155-4e67-af40-e760ae665105)

![Untitled 25](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/89914ad4-da64-483c-8136-928116c6ae1c)

```java
[
  {
    "id": 1,
    "category": {
      "id": 1,
      "name": "ì „ìê¸°ê¸°"
    },
    "seller": {
      "id": 1,
      "nickName": null
    },
    "title": "t1",
    "dealType": "SELL",
    "description": "string",
    "dealPlace": "string",
    "price": 0,
    "isPriceOffer": true,
    "status": "SALE",
    "likedCount": 0,
    "viewCount": 0,
    "pullupAt": null
  },
  {
    "id": 2,
    "category": {
      "id": 1,
      "name": "ì „ìê¸°ê¸°"
    },
    "seller": {
      "id": 1,
      "nickName": null
    },
    "title": "t2",
    "dealType": "SELL",
    "description": "string",
    "dealPlace": "string",
    "price": 0,
    "isPriceOffer": true,
    "status": "SALE",
    "likedCount": 0,
    "viewCount": 0,
    "pullupAt": null
  }
]
```

## post ë‹¨ê±´ ì¡°íšŒ

![Untitled 26](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/dbb1132d-0a1a-4856-8e27-b132e3110182)

![Untitled 27](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/57804ff0-8c12-4f63-b158-fc4d93069102)

## post ìˆ˜ì •

![Untitled 28](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/d2f735c8-dc8d-4e48-a57c-dfd6fdbbc809)

title ì„ ìˆ˜ì •í•´ë³´ê² ìŠµë‹ˆë‹¤

![Untitled 29](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/81abe3ec-736d-4b34-a1b7-ff8afdbe72e6)

## post ì‚­ì œ

![Untitled 30](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/ebe110fc-19aa-4fad-b689-965d6ae4c4a8)

![Untitled 31](https://github.com/CEOS-Developers/spring-daagn-market-18th/assets/48885608/776af15d-7ea7-408f-b47d-a2a951e14b0f)

---

# ëŠë‚€ ì  ë° ê³ ë¯¼

- ì§€ì—°ë¡œë”© ì„¸íŒ… ë° N+1 ë¬¸ì œ í•´ê²°í•´ì•¼ í•©ë‹ˆë‹¤
- controller ì—ì„œ service ë‹¨ì— ë°ì´í„°ë¥¼ ë„˜ê²¨ì¤„ ë•Œ ì–´ë–»ê²Œ í•´ì•¼ ë” ê¹”ë”í•˜ê²Œ ë„˜ê²¨ì¤„ ìˆ˜ ìˆì„ ì§€ ê³ ë¯¼ì…ë‹ˆë‹¤.
- service ë‹¨ì—ì„œ ì¸í„°í˜ì´ìŠ¤ì™€ impl íŒ¨í„´ ì‚¬ìš© ì‹œ ì¥ë‹¨ì ê³¼ í”„ë¡œì íŠ¸ì—ì„œ ì ìš© ì—¬ë¶€ì— ëŒ€í•œ ê³ ë¯¼
- vo ë¥¼ ì´ë ‡ê²Œ ì“°ëŠ”ê²Œ ë§ëŠ”ê±´ì§€ì— ëŒ€í•œ ì˜ë¬¸
- ì»¤ë§¨ë“œ, ì¿¼ë¦¬ë¥¼ ë¶„ë¦¬í•˜ëŠ” íŒ¨í„´ ë˜í•œ ìš°ë¦¬ ìˆ˜ì¤€ í”„ë¡œì íŠ¸ì—ì„œ ìœ ì˜ë¯¸í•œ ì¥ì ì´ ìˆì„ê¹Œ í•˜ëŠ” ê³ ë¯¼

---

# ğŸŒ± 4ì£¼ì°¨ ë¯¸ì…˜

# 1ï¸âƒ£Â JWT ì¸ì¦(Authentication) ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê¸°

## ì¸ì¦ vs ì¸ê°€

```
ì¸ì¦ : ì´ ì„œë¹„ìŠ¤ì—ì„œ í•´ë‹¹ ì‚¬ìš©ìê°€ ìœ íš¨í•¨ì„ í™•ì¸
ì¸ê°€ : ì‚¬ìš©ì ì¸ì¦ì´ ì´ë¤„ì§„ ë’¤, ì‚¬ìš©ìê°€ ì ‘ê·¼í•˜ëŠ” ë¦¬ì†ŒìŠ¤(ìì›)ì— ëŒ€í•´ì„œ ê¶Œí•œì„ í™•ì¸ ë° ì œí•œ
```

## JWTë¥¼ ì´ìš©í•œ ì¸ì¦ ë°©ì‹ (access token, refresh token)

### ê°œë…ì 

A. JWT ì¸ì¦ ì „ë°˜ì ì¸ ë°œì „ê³¼ì •.

```
1. ìš°ì„ , ì´ˆê¸°ì—” í•˜ë‚˜ì˜ í† í° access_token ë§Œ ì¡´ì¬í•˜ì—¬, ì‚¬ìš©ì ì¸ì¦ì„ ì§„í–‰í•˜ì˜€ìŒ.

2. ë‹¤ë§Œ, access_token ì€ ì €ì¥ë˜ëŠ” ê°’ì´ ì•„ë‹ˆê¸°ì— ìœ ì¶œë˜ì—ˆì„ ë•Œ, ì„œë²„ì—ì„œ ì´ë¥¼ ì˜ëª»ëœ ì‚¬ìš©ìì¸ì§€ íŒë‹¨í•  ìˆ˜ ì—†ìŒ.

3. ê·¸ë ‡ê¸°ì— Lifespan(í† í° ìƒì¡´ì£¼ê¸°) ë¥¼ ì§§ê²Œ ì„¤ì •í•˜ì—¬ ì´ë¥¼ ìµœëŒ€í•œ ë°©ì–´í•˜ì˜€ìŒ.

4. ê·¸ ê²°ê³¼, ìœ ì €ê°€ ë¡œê·¸ì¸ì„ ìì£¼í•´ì•¼í•˜ëŠ” ìƒí™©ì´ ë°œìƒ.
```

B. access_token / refresh_token

```
1. access_token ì€ (1ì‹œê°„ ~ 1ì¼, ê¸ˆìœµ ë“± ì¤‘ìš” ê¸°ê´€ì—ì„  30ì´ˆ) ë“± ì§§ì€ Lifespan. (ì €ì¥ë˜ì§€ ì•ŠìŒ)

2. refresh_token ì€ (2ì£¼, 1ë‹¬, ì˜êµ¬) ë“± ê¸´ Lifespanì„ ê°€ì§€ê²Œ ë˜ì—ˆìŒ.

3. ì´ë¡œì¸í•´ ì•ì„œ ìœ ì €ê°€ í† í° ë§Œë£Œë¡œ ë¡œê·¸ì¸í•´ì•¼í•˜ëŠ” ì‹œì ì— refresh_tokenìœ¼ë¡œ access_tokenì„ ì¬ ë°œê¸‰ë°›ìŒ.

4. ì—¬ê¸°ì„œ ë¬¼ìŒì´ ë“œëŠ”ê²ƒì€ ê·¸ëŸ¬ë©´ refresh_tokenì´ ìœ ì¶œë˜ë©´ ë˜‘ê°™ì´ ë¬¸ì œ ì•„ë‹Œê°€?
   => ì´ê±´ ì–´ì©” ìˆ˜ ì—†ìŒ. refresh token ì´ íƒˆì·¨ë¨ì„ ì¸ì§€í•˜ê³  DB ì—ì„œ ë§Œë£Œì‹œí‚¤ê±°ë‚˜, refresh_toekn ì´ ë§Œë£Œë˜ì§€ ì•ŠëŠ” ì´ìƒ ë³´ì•ˆ ë¬¸ì œê°€ ë°œìƒ
```

C. refresh_token ì¢€ ë” ìì„¸íˆ

```
1. aceess_token ì€ ì–´ë”˜ê°€ ì €ì¥ë˜ì§€ì•Šê³ (í”„ë¡ íŠ¸ì—ëŠ” ì €ì¥ë˜ê² ì§€ë§Œ) í† í° ìì²´ë¥¼ í•´ì„í•´ì„œ ì¸ì¦ì„ í•˜ëŠ”ê²ƒê³¼ ë‹¬ë¦¬.

2. refresh_token ì€ í† í° ìì²´ì— ìœ ì €ì •ë³´ë„ ìˆì§€ë§Œ, DB(database, file, redis ë“±)ì— ì €ì¥ë˜ëŠ” ê°’ì„, ê·¸ë ‡ê¸°ì— ì„œë²„ì¸¡ì˜ ì˜ë„ë¡œ ë§Œë£Œì‹œí‚¬ ìˆ˜ ìˆìŒ. (ê¸°ìˆ ì ìœ¼ë¡œ, refresh_token ì„ ì €ì¥í•˜ì§€ ì•Šê³  ìœ ì € ë¡œê·¸ì™€ refresh_tokenì„ ëŒ€ì¡° í•˜ëŠ” ë“± ë‹¤ë¥¸ ë°©ë²•ë„ ìˆìŒ.)

3. ê·¸ë ‡ê¸°ì— íŠ¹ìˆ˜í•œ ìƒí™©(ë‹¤ë¥¸ ë””ë°”ì´ìŠ¤ ì ‘ì†, ë‹¤ë¥¸ ì•„ì´í”¼ ì ‘ì†, ë‹¤ë¥¸ ì§€ì—­ ì ‘ì† ë“±)ì— ì„œë²„ê°€ ì„ì˜ë¡œ ë§Œë£Œì‹œí‚¬ ìˆ˜ ìˆìŒ.

4. ëŒ€ê·œëª¨ ì„œë¹„ìŠ¤ì—ì„œ access_token ì€ ìš°ë¦¬ê°€ ê°œë°œí•œ API ì„œë²„(Resource Server)ë¡œ ì „ë‹¬ë˜ê² ì§€ë§Œ. refresh_tokenì€ ìš°ë¦¬ API ì„œë²„ê°€ ì•„ë‹Œ ë³„ë„ì˜ ì¸ì¦ì„œë²„(Authorization Server)ì—ì„œ ì²˜ë¦¬í•´ì£¼ëŠ”ê²ƒì´ ì¼ë°˜ì 
```

D. ì¸ì¦ì„œë²„(Authorization Server)

```
1. ì†Œê·œëª¨ í”„ë¡œì íŠ¸ì—ì„  í•˜ë‚˜ì˜ ì„œë²„ì—ì„œ ê´€ë¦¬í•˜ê² ì§€ë§Œ.

2. ëŒ€ê·œëª¨ ì„œë¹„ìŠ¤ì˜ ê²½ìš° ë³„ë„ë¡œ ì¸ì¦ì„œë²„ë¥¼ ê´€ë¦¬í•¨(Authorization ì„œë²„ì™€ Resource ì„œë²„ë¥¼ ë¶„ë¦¬í•˜ëŠ”ê²Œ ë” ì¼ë°˜ì ì¸ ì•„í‚¤í…ì³)

3. ë˜í•œ ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” SNS ë¡œê·¸ì¸, Cognito(AWS)ë¡œê·¸ì¸ ë“±ì€ ì¸ì¦ì„œë²„ê°€ í•´ë‹¹ íšŒì‚¬ ì¸ì¦ ì„œë²„(AWS, Facebook, Kakaotalk)ì„

4. í•´ë‹¹ ì¸ì¦ì„œë²„ì—ì„œëŠ” refresh_tokenìœ¼ë¡œ ìš”ì²­í•œë‹¤ê³  ë°”ë¡œ access_tokenì„ ì£¼ëŠ”ê²Œ ì•„ë‹Œ, ì—¬ëŸ¬ë°©ë²•ìœ¼ë¡œ ë³´ì•ˆì„ ìœ ì§€í•¨.

E. ë³´ì•ˆ ìœ ì§€ ë°©ë²•.
1. ì•ì„œ ë§í•œ ìƒí™©(ë‹¤ë¥¸ ë””ë°”ì´ìŠ¤ ì ‘ì†, ë‹¤ë¥¸ ì•„ì´í”¼ ì ‘ì†, ë‹¤ë¥¸ ì§€ì—­ ì ‘ì† ë“±)ì‹œ refresh_token ë§Œë£Œ ì‹œí‚¤ê³  ì¬ë¡œê·¸ì¸ ìš”êµ¬.

2. ì¶”ê°€ì ìœ¼ë¡œ ì‚¬ìš©ìì¸ì¦(íœ´ëŒ€í° ë¬¸ì ì¸ì¦ ë“±)ì„ ìš”êµ¬.
3. ë“±

ì¦‰, access_token ì„ íƒˆì·¨í•˜ê¸°ì—” ìƒëª…ì£¼ê¸°ê°€ ì§§ì•„ ì´ë¥¼ ë°©ì§€í•˜ê³ ,  ê³µê²©ìê°€ refresh_token ì„ íƒˆì·¨í•˜ë”ë¼ë„, Authorization ì„œë²„ì˜ ì¸ì¦, ë³´ì•ˆ ì ˆì°¨ë¡œ ì¸í•´ ê³µê²©ì´ ì–´ë µê²Œ ëœë‹¤.
```

## ì„¸ì…˜/ì¿ í‚¤ ë°©ì‹ vs JWT

### ì„¸ì…˜ ì¸ì¦ ë°©ì‹ì˜ í”Œë¡œìš°

![[https://velog.io/@gusdnr814/ë¡œê·¸ì¸-ì¸ì¦-4ê°€ì§€-ë°©ë²•](https://velog.io/@gusdnr814/%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%9D%B8%EC%A6%9D-4%EA%B0%80%EC%A7%80-%EB%B0%A9%EB%B2%95)](ceos_4ì£¼ì°¨_img/Untitled.png)

[https://velog.io/@gusdnr814/ë¡œê·¸ì¸-ì¸ì¦-4ê°€ì§€-ë°©ë²•](https://velog.io/@gusdnr814/%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%9D%B8%EC%A6%9D-4%EA%B0%80%EC%A7%80-%EB%B0%A9%EB%B2%95)

- ì„¸ì…˜ ì¸ì¦ì€ ì¿ í‚¤ë¥¼ ê°™ì´ ì‚¬ìš©í•¨

### JWT ì¸ì¦ ë°©ì‹ì˜ í”Œë¡œìš°

![[https://llshl.tistory.com/32](https://llshl.tistory.com/32)](ceos_4ì£¼ì°¨_img/Untitled%201.png)

[https://llshl.tistory.com/32](https://llshl.tistory.com/32)

- JWT ë°©ì‹ì˜ ì¥ì 
  - ë¬´ìƒíƒœì„±(stateless) : JWT ìì²´ì— ì •ë³´ë¥¼ í¬í›”í•˜ê°€ ìˆìœ¼ë¯€ë¡œ ì„œë²„ì— ì €ì¥í•  í•„ìš”ê°€ ì—†ë‹¤.
  - í™•ì¥ì„± : ë¶„ì‚° ì•„í‚¤í…ì³ì—ì„œ ìš°ë¦¬
  - ì„œë²„ ë¶€í•˜ ê°ì†Œ

- JWT ë°©ì‹ì˜ ë‹¨ì 
  - í† í°ì˜ í¬ê¸°ê°€ ì»¤ì§€ë©´ ë„¤íŠ¸ì›Œí¬ ë¹„ìš©ì´ ì¦ê°€í•  ìˆ˜ ìˆìŒ
  - ëˆ„êµ¬ë‚˜ í† í°ì„ ë””ì½”ë”© í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¯¼ê°í•œ ì •ë³´ëŠ” í† í°ì— ë‹´ì§€ ëª»í•¨
  - ì„œë²„ì—ì„œ í† í°ì„ ê°•ì œë¡œ ë§Œë£Œì‹œí‚¤ê¸° ì–´ë ¤ì›€ â†’ but, access token ì˜ ì£¼ê¸°ë¥¼ ì§§ê²Œ í•˜ê³ , refresh token ì„ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ì–´ëŠ ì •ë„ í•´ê²° ê°€ëŠ¥
  - êµ¬í˜„ì´ ì„¸ì…˜ ë°©ì‹ë³´ë‹¤ ë³µì¡

# 2ï¸âƒ£Â ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ë° ê²€ì¦ ë¡œì§ êµ¬í˜„í•˜ê¸°

## êµ¬í˜„í•œ íŒŒíŠ¸

```
- ID/PW ë¡œ íšŒì›ê°€ì…
- ë¡œê·¸ì¸
- ë¡œê·¸ì¸ ì‹œ access toekn ë°œê¸‰
- access token ìœ¼ë¡œ ì‚¬ìš©ì ì‹ë³„
- ì‚¬ìš©ì ê¶Œí•œì— ë”°ë¼ api í˜¸ì¶œ í—ˆìš© or ì œí•œ
```

## êµ¬í˜„ ì½”ë“œ

### ë””ë ‰í„°ë¦¬ êµ¬ì¡°

```
.
â”œâ”€â”€ Application.java
â”œâ”€â”€ InitDb.java
â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ ModelMapperConfig.java
â”‚Â Â  â”œâ”€â”€ OpenApiConfig.java
â”‚Â Â  â””â”€â”€ P6SpyFormatter.java
â”œâ”€â”€ controller
â”‚Â Â  â”œâ”€â”€ PostApiController.java
â”‚Â Â  â””â”€â”€ SignController.java
â”œâ”€â”€ dto
â”‚Â Â  â”œâ”€â”€ post
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ request
â”‚Â Â  â”‚Â Â  â””â”€â”€ response
â”‚Â Â  â”œâ”€â”€ signIn
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ request
â”‚Â Â  â”‚Â Â  â””â”€â”€ response
â”‚Â Â  â””â”€â”€ signUp
â”‚Â Â      â”œâ”€â”€ request
â”‚Â Â      â””â”€â”€ response
â”œâ”€â”€ entity
â”‚Â Â  â”œâ”€â”€ Category.java
â”‚Â Â  â”œâ”€â”€ ChatMessage.java
â”‚Â Â  â”œâ”€â”€ ChatRoom.java
â”‚Â Â  â”œâ”€â”€ CompletedDeal.java
â”‚Â Â  â”œâ”€â”€ DealReview.java
â”‚Â Â  â”œâ”€â”€ Member.java
â”‚Â Â  â”œâ”€â”€ MembersChatRoom.java
â”‚Â Â  â”œâ”€â”€ Post.java
â”‚Â Â  â”œâ”€â”€ PostImage.java
â”‚Â Â  â”œâ”€â”€ base
â”‚Â Â  â”‚Â Â  â””â”€â”€ BaseTimeEntity.java
â”‚Â Â  â””â”€â”€ enums
â”‚Â Â      â”œâ”€â”€ DealType.java
â”‚Â Â      â”œâ”€â”€ MemberRole.java
â”‚Â Â      â””â”€â”€ PostStatus.java
â”œâ”€â”€ repository
â”‚Â Â  â”œâ”€â”€ CategoryRepository.java
â”‚Â Â  â”œâ”€â”€ MemberRepository.java
â”‚Â Â  â””â”€â”€ PostRepository.java
â”œâ”€â”€ security
â”‚Â Â  â”œâ”€â”€ JwtAuthenticationFilter.java
â”‚Â Â  â”œâ”€â”€ SecurityConfig.java
â”‚Â Â  â”œâ”€â”€ TokenProvider.java
â”‚Â Â  â””â”€â”€ authorize
â”‚Â Â      â”œâ”€â”€ AdminAuthorize.java
â”‚Â Â      â””â”€â”€ UserAuthorize.java
â”œâ”€â”€ service
â”‚Â Â  â”œâ”€â”€ PostService.java
â”‚Â Â  â””â”€â”€ SignService.java
â””â”€â”€ vo
    â”œâ”€â”€ CategoryVo.java
    â””â”€â”€ MemberVo.java
```

### íŒ¨í‚¤ì§€ ì„¤ì¹˜

```java
// spring security , jwt
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'io.jsonwebtoken:jjwt-api:0.11.2'
	implementation 'io.jsonwebtoken:jjwt-impl:0.11.2'
	implementation 'io.jsonwebtoken:jjwt-jackson:0.11.2'
```

### íšŒì›ê°€ì…(sign up), ë¡œê·¸ì¸(sign in) req,res dto

ğŸ”–Â `SignInRequestDto`

```java
package com.ceos18.springboot.dto.signIn.request;

import io.swagger.v3.oas.annotations.media.Schema;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Getter
@NoArgsConstructor
public class SignInRequestDto {
	@Schema(description = "íšŒì› ì•„ì´ë””", example = "abc123")
	String account;
	@Schema(description = "íšŒì› ë¹„ë°€ë²ˆí˜¸", example = "1234")
	String password;
}
```

ğŸ”–Â `SignInResponseDto`

```java
package com.ceos18.springboot.dto.signIn.response;

import com.ceos18.springboot.entity.enums.MemberRole;
import io.swagger.v3.oas.annotations.media.Schema;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@NoArgsConstructor
public class SignInResponseDto {

	String email;
	String accessToken;
	String refreshToken;
	String nickName;
	@Schema(description = "íšŒì› ë¡¤", example = "USER")
	MemberRole role;

	public SignInResponseDto(String email, String accessToken, String refreshToken, String nickName, MemberRole role) {
		this.email = email;
		this.accessToken = accessToken;
		this.refreshToken = refreshToken;
		this.nickName = nickName;
		this.role = role;
	}
}
```

ğŸ”–Â `SignUpRequestDto`

```java
package com.ceos18.springboot.dto.signUp.request;

import io.swagger.v3.oas.annotations.media.Schema;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Getter
@NoArgsConstructor
public class SignUpRequestDto {
	@Schema(description = "íšŒì› ì•„ì´ë””", example = "abc123")
	String account;
	@Schema(description = "íšŒì› ë¹„ë°€ë²ˆí˜¸", example = "1234")
	String password;
	@Schema(description = "íšŒì› ì´ë©”ì¼", example = "abc@gmail.com")
	String email;
	@Schema(description = "íšŒì› ë‹‰ë„¤ì„", example = "ë³„ëª…")
	String nickName;
}
```

ğŸ”–Â `SignUpResponseDto`

```java
@Getter
@Setter
public class SignUpResponseDto {

	@Schema(description = "íšŒì› ì•„ì´ë””", example = "1")
	Long id;
	@Schema(description = "íšŒì› ì•„ì´ë””", example = "abc123")
	String account;
	@Schema(description = "íšŒì› ì´ë©”ì¼", example = "abc@gmail.com")
	String email;
	@Schema(description = "íšŒì› ë‹‰ë„¤ì„", example = "ë³„ëª…")
	String nickName;

	public static SignUpResponseDto from(Member member) {
		SignUpResponseDto signUpResponseDto = new SignUpResponseDto();
		signUpResponseDto.setId(member.getId());
		signUpResponseDto.setAccount(member.getAccount());
		signUpResponseDto.setEmail(member.getEmail());
		signUpResponseDto.setNickName(member.getNickName());
		return signUpResponseDto;
	}
}
```

### SignService

```java
@RequiredArgsConstructor
@Service
public class SignService {
	private final MemberRepository memberRepository;
	private final TokenProvider tokenProvider;
	private final PasswordEncoder encoder;

	@Transactional
	public SignUpResponseDto registMember(SignUpRequestDto request) {
		Member member = memberRepository.save(Member.from(request, encoder));
		try {
			memberRepository.flush();
		} catch (DataIntegrityViolationException e) {
			throw new IllegalArgumentException("ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.");
		}
		return SignUpResponseDto.from(member);
	}

	@Transactional(readOnly = true)
	public SignInResponseDto signIn(SignInRequestDto request) {
		Member member = memberRepository.findByAccount(request.getAccount())
				.filter(it -> encoder.matches(request.getPassword(), it.getPassword()))	// ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„êµí•˜ë„ë¡ ìˆ˜ì •
				.orElseThrow(() -> new IllegalArgumentException("ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));

		String token = tokenProvider.createToken(String.format("%s:%s", member.getId(), member.getRole().name()));

		// email, refresh token, nickName
		return new SignInResponseDto(member.getEmail(), token, member.getRefreshToken(), member.getNickName(), member.getRole());
	}
}
```

- ì¸ì¦ ì„œë¹„ìŠ¤
  - `registMember()` (íšŒì›ê°€ì…)
  - `signIn()` (ë¡œê·¸ì¸)

### SignController

```java
@Tag(name = "íšŒì› ê°€ì… ë° ë¡œê·¸ì¸")
@RequiredArgsConstructor
@RestController
@RequestMapping("/api/v1")
public class SignController {
	private final SignService signService;

	@Operation(summary = "íšŒì› ê°€ì…")
	@PostMapping("/sign-up")
	public SignUpResponseDto signUp(@RequestBody SignUpRequestDto request) {
		return signService.registMember(request);
	}

	@Operation(summary = "ë¡œê·¸ì¸")
	@PostMapping("/sign-in")
	public SignInResponseDto signIn(@RequestBody SignInRequestDto request) {
		return signService.signIn(request);
	}
}
```

### jwt í”„ë¡œí¼í‹° ì„¤ì •

public repo ì— ì˜¬ë¼ê°€ì§€ ì•Šê²Œë” ë³„ë„ì˜ íŒŒì¼ë¡œ ë¶„ë¦¬í•´ì„œ ê´€ë¦¬

ğŸ”–Â `resources/jwt.yml`

```java
secret-key: NiOeyFbN1Gqo10bPgUyTFsRMkJpGLXSvGP04eFqj5B30r5TcrtlSXfQ7TndvYjNvfkEKLqILn0j1SmKODO1Yw3JpBBgI3nVPEahqxeY8qbPSFGyzyEVxnl4AQcrnVneI
expiration-hours: 3
issuer: abc123
```

### TokenProvider

JWT ë¥¼ ìƒì„±í•˜ê³  ìœ íš¨ì„±ì„ ê²€ì¦

```java
@PropertySource("classpath:jwt.yml")
@Service
public class TokenProvider {
	private final String secretKey;
	private final long expirationHours;
	private final String issuer;

	public TokenProvider(
			@Value("${secret-key}") String secretKey,
			@Value("${expiration-hours}") long expirationHours,
			@Value("${issuer}") String issuer
	) {
		this.secretKey = secretKey;
		this.expirationHours = expirationHours;
		this.issuer = issuer;
	}

	public String createToken(String userSpecification) {
		return Jwts.builder()
				.signWith(new SecretKeySpec(secretKey.getBytes(), SignatureAlgorithm.HS512.getJcaName()))   // HS512 ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ secretKeyë¥¼ ì´ìš©í•´ ì„œëª…
				.setSubject(userSpecification)  // JWT í† í° ì œëª©
				.setIssuer(issuer)  // JWT í† í° ë°œê¸‰ì
				.setIssuedAt(Timestamp.valueOf(LocalDateTime.now()))    // JWT í† í° ë°œê¸‰ ì‹œê°„
				.setExpiration(Date.from(Instant.now().plus(expirationHours, ChronoUnit.HOURS)))    // JWT í† í° ë§Œë£Œ ì‹œê°„
				.compact(); // JWT í† í° ìƒì„±
	}

	public String validateTokenAndGetSubject(String token) {
		return Jwts.parserBuilder()
				.setSigningKey(secretKey.getBytes())
				.build()
				.parseClaimsJws(token)
				.getBody()
				.getSubject();
	}
}
```

- `createToken()` : SignService ì—ì„œ í˜¸ì¶œí•  ë•Œ ìœ ì €ì˜ ì •ë³´ë¥¼ ê°™ì´ ë„˜ê²¨ì¤˜ì„œ ìœ ì € ì •ë³´ë¡œ jwt ë¥¼ ìƒì„±í•œë‹¤.
- `validateTokenAndGetSubject()` : ì£¼ì–´ì§„ jwt í† í°ì„ ê²€ì¦í•˜ê³ , ìœ íš¨í•œ í† í°ì´ë¼ë©´ subject ë¥¼ ë°˜í™˜í•œë‹¤.

### JwtAuthenticationFilter

í† í° ì •ë³´ì—ì„œ ì‚¬ìš©ì ì¸ì¦ í•„í„°

```java
@Order(0)
@RequiredArgsConstructor
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
	private final TokenProvider tokenProvider;

	@Override
	protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
		try {
			String token = parseBearerToken(request);
			User user = parseUserSpecification(token);
			AbstractAuthenticationToken authenticated = UsernamePasswordAuthenticationToken.authenticated(user, token, user.getAuthorities());
			authenticated.setDetails(new WebAuthenticationDetails(request));
			SecurityContextHolder.getContext().setAuthentication(authenticated);
		} catch (Exception e) {
			request.setAttribute("exception", e);
		}

		filterChain.doFilter(request, response);
	}

	private String parseBearerToken(HttpServletRequest request) {
		return Optional.ofNullable(request.getHeader(HttpHeaders.AUTHORIZATION))
				.filter(token -> token.substring(0, 7).equalsIgnoreCase("Bearer "))
				.map(token -> token.substring(7))
				.orElse(null);
	}

	private User parseUserSpecification(String token) {
		String[] split = Optional.ofNullable(token)
				.filter(subject -> subject.length() >= 10)
				.map(tokenProvider::validateTokenAndGetSubject)
				.orElse("anonymous:anonymous")
				.split(":");

		return new User(split[0], "", List.of(new SimpleGrantedAuthority(split[1])));
	}
}
```

- ****`doFilterInternal`****

  OncePerRequestFilter ë¥¼ ìƒì†ë°›ì•„ì„œ êµ¬í˜„í•œ ì‹œíë¦¬í‹° í•„í„°

  ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ê³ , ì•„ë˜ì˜ **`parseBearerToken` ì™€ `parseUserSpecification`** ë¥¼ í˜¸ì¶œí•¨ìœ¼ë¡œì¨ í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¶”ì¶œí•¨


- ****`parseBearerToken`****

  HTTP í—¤ë”ì—ì„œ Bearer í† í°ì„ ì¶”ì¶œ

- ****`parseUserSpecification`****

  ì¶”ì¶œí•œ Bearer í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ íŒŒì‹±í•œ ë’¤ spring security ì˜ User ê°ì²´ë¥¼ ìƒì„±


### SecurityConfig ì—ì„œ í•„í„° ì¶”ê°€

ì•ì„œì„œ ë§Œë“  `JwtAuthenticationFilter` ë¥¼ í•„í„° ì²´ì¸ì— ì¶”ê°€í•œë‹¤.

```java
@EnableMethodSecurity
@RequiredArgsConstructor
@Configuration
public class SecurityConfig {

	private final JwtAuthenticationFilter jwtAuthenticationFilter;

	private final String[] allowedUrls = {"/swagger-ui/**", "/api/v1/sign-up", "/api/v1/sign-in"};

	@Bean
	public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
		return http
				.csrf().disable()
				.headers(headers -> headers.frameOptions().sameOrigin())
				.authorizeHttpRequests(requests ->
						requests.requestMatchers(allowedUrls).permitAll()
								.anyRequest().authenticated()
				)
				.sessionManagement(sessionManagement ->
						sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
				)
				.addFilterBefore(jwtAuthenticationFilter, BasicAuthenticationFilter.class)	// ì¶”ê°€
				.build();
	}
```

### ì¸ê°€ë¥¼ ìœ„í•œ ì»¤ìŠ¤í…€ ì¸í„°í˜ì´ìŠ¤ ìƒì„±

ì¸ê°€ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•œ ë‘ ê°€ì§€ ë°©ë²•

- Authorization Filter êµ¬í˜„í•´ì„œ ì‹œíë¦¬í‹° í•„í„° ì²´ì¸ì— ë“±ë¡
- ì»¨íŠ¸ë¡¤ëŸ¬ì— @PreAuthorize() ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©

ë‘ ë²ˆì§¸ ë°©ë²•ì„ ì„ íƒ

í¸ì˜ë¥¼ ìœ„í•´ @PreAuthorize() ì„ ë˜í•‘í•˜ëŠ” ì»¤ìŠ¤í…€ ì¸í„°í˜ì´ìŠ¤ ìƒì„±

ğŸ”–Â `AdminAuthorize`

```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@PreAuthorize("hasAuthority('ADMIN')")
public @interface AdminAuthorize {
}
```

ğŸ”–Â `UserAuthorize`

```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@PreAuthorize("hasAuthority('USER')")
public @interface UserAuthorize {
}
```

PostApiController ì— USER role ì„ ê°€ì§„ ì‚¬ìš©ìë§Œ í˜¸ì¶œí•˜ê²Œë” ì„¤ì •

```java
@RequiredArgsConstructor
@RestController
@RequestMapping("/api/v1")
@UserAuthorize
public class PostApiController {
	// ìƒëµ..
}
```

# 3ï¸âƒ£Â í…ŒìŠ¤íŠ¸

### ğŸ”–Â ì¸ì¦ ì•ˆ ëœ ì‚¬ìš©ìê°€ api í˜¸ì¶œí•  ë•Œ

![Untitled](ceos_4ì£¼ì°¨_img/Untitled%202.png)

â¡ï¸Â 403 ì—ëŸ¬ê°€ ë°œìƒ

### ğŸ”–Â íšŒì›ê°€ì…

- request

![Untitled](ceos_4ì£¼ì°¨_img/Untitled%203.png)

- response

![Untitled](ceos_4ì£¼ì°¨_img/Untitled%204.png)

![Untitled](ceos_4ì£¼ì°¨_img/Untitled%205.png)

DB ì— password ì•”í˜¸í™”ë˜ì„œ ì˜ ë“¤ì–´ê°

### ğŸ”–Â ë¡œê·¸ì¸

- request

![Untitled](ceos_4ì£¼ì°¨_img/Untitled%206.png)

- response

![Untitled](ceos_4ì£¼ì°¨_img/Untitled%207.png)

### ğŸ”–Â ì¸ì¦ëœ ìœ ì €ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” api í˜¸ì¶œ

HTTP ìš”ì²­ì˜ í—¤ë”ì— Bearer í† í° ë“±ë¡

![Untitled](ceos_4ì£¼ì°¨_img/Untitled%208.png)

![Untitled](ceos_4ì£¼ì°¨_img/Untitled%209.png)

response ì •ìƒ ì‘ë‹µ

# ğŸŒ±Â 5ì£¼ì°¨ ë¯¸ì…˜

# 1ï¸âƒ£Â ë¡œì»¬ì—ì„œ ë„ì»¤ ì‹¤í–‰í•´ë³´ê¸°

## 1. jar ë¹Œë“œ

`./gradlew clean build`

## 2. Dockerfile

```docker
FROM openjdk:17
ARG JAR_FILE=/build/libs/*.jar
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-jar", "/app.jar"]
```

## 3. docker-compose ì™€ í™˜ê²½ë³€ìˆ˜ ì„¤ì •

### dev í™˜ê²½

`docker-compose-dev.yml`

dev profile : web ê³¼ db ì»¨í…Œì´ë„ˆë¥¼ ëª¨ë‘ ë„ì›€

```yaml
version: "3.7"
services:
  db:
    image: mysql
    container_name: spring-daangn-db
    env_file:
      - .env.dev
    ports:
      - "3307:3306"
    volumes:
      - ./dockerDB:/app
    restart: always
  web:
    container_name: spring-daangn-server
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    depends_on:
      - db
    restart: always
```

`application-dev.yml`

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://db:3306/daangn?serverTimezone=Asia/Seoul
    username: root
    password: 1234
```

### local í™˜ê²½

`docker-compose-local.yml`

local profile : web ë§Œ ë„ìš°ê³ , db ëŠ” ë¡œì»¬db ì— ë¶™ìŒ

```yaml
version: "3.7"
services:
  web:
    container_name: spring-daangn-server
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=local
```

- SPRING_PROFILES_ACTIVE ë¡œ local profile ì£¼ì…

`application-local.yml`

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://host.docker.internal:3306/ceos_18?serverTimezone=Asia/Seoul
    username: root
    password: <password>
```

- host ëª…ì´ `localhost` ê°€ ì•„ë‹ˆë¼ `host.docker.internal` ì„ì— ì£¼ì˜ (ì»¨í…Œì´ë„ˆ ê´€ì ìœ¼ë¡œ ìƒê°)

1. ë¹Œë“œ í›„ ì»¨í…Œì´ë„ˆ ë„ìš°ê¸°

   `./gradlew clean build`

   local : `docker-compose -f docker-compose-local.yml up --build`

   dev : `docker-compose -f docker-compose-dev.yml up --build`


# íŠ¸ëŸ¬ë¸” ìŠˆíŒ…

## 1. ìë°” ë²„ì „ìœ¼ë¡œ ì¸í•œ ë¹Œë“œ ì—ëŸ¬

ì¸í…”ë¦¬ì œì´ IDE ì—ì„œ ë¹Œë“œë¥¼ í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ í„°ë¯¸ë„ ìƒì—ì„œ `./gradlew clean build` ì»¤ë§¨ë“œë¡œ ë¹Œë“œë¥¼ ì‹œë„í•˜ì˜€ì„ ë•Œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì˜€ìŒ

### ì›ì¸ : ìë°” ë²„ì „ ë¬¸ì œ

ìŠ¤í”„ë§ë¶€íŠ¸3ëŠ” ìë°”17 ê¸°ë°˜ì¸ë° í˜„ì¬ ë¡œì»¬ì— ì„¤ì •ëœ ìë°”ëŠ” ìë°”11ì´ì˜€ìŒ

IDE ì—ì„œëŠ” JDK17 ì„ ì„¤ì •í•´ë†¨ê¸° ë•Œë¬¸ì— ê·¸ë™ì•ˆ ë¬¸ì œê°€ ì—†ì—ˆëŠ”ë° í„°ë¯¸ë„ë¡œ jar ë¥¼ ë¹Œë“œ,ì‹¤í–‰í• ë•ŒëŠ” ë¬¸ì œê°€ ë°œìƒ

![Untitled](ceos_5ì£¼ì°¨_img/Untitled.png)

![Untitled](ceos_5ì£¼ì°¨_img/Untitled%201.png)

### í•´ê²°ë°©ë²•

- ë¡œì»¬ì— ì„¤ì¹˜ë¼ìˆëŠ” ë‹¤ë¥¸ ìë°” ë²„ì „ í™•ì¸

  `/usr/libexec/java_home -V`


![Untitled](ceos_5ì£¼ì°¨_img/Untitled%202.png)

- JAVA_HOME í™˜ê²½ë³€ìˆ˜ ë³€ê²½

    ```bash
    export JAVA_HOME=$(/usr/libexec/java_home -v 17)
    ```


ê·¸ëŸ°ë° ì´ë ‡ê²Œ í•˜ë©´ ìë°”ë³€ê²½ì´ í•„ìš”í•  ë•Œë§ˆë‹¤ ë§¤ë²ˆ í™˜ê²½ë³€ìˆ˜ë¥¼ ë°”ê¿”ì¤˜ì•¼ í•˜ë¯€ë¡œ ë²ˆê±°ë¡œì›€

â‡’ ìë°” ë²„ì „ ë³€ê²½ íˆ´ì„ ì‚¬ìš©

- node ì§„ì˜ì˜ nvm ì´ë‚˜, python ì˜ pyenv ì²˜ëŸ¼ ë¡œì»¬ì˜ ìë°”ë²„ì „ ë³€ê²½ì„ ìœ„í•œ íˆ´
  - SDKMAN
  - jEnv
  - Jabba


SDKMAN ì„ ì‚¬ìš©

1. SDKMAN ì„¤ì¹˜ ë° ì´ˆê¸°í™”


    ```bash
    curl -s "https://get.sdkman.io" | bash
    ```
    
    ```bash
    source "$HOME/.sdkman/bin/sdkman-init.sh"
    ```


1. **ì›í•˜ëŠ” ìë°” ë²„ì „ ì„¤ì¹˜:**
   ì‚¬ìš© ê°€ëŠ¥í•œ ìë°” ë²„ì „ ëª©ë¡ì„ í™•ì¸

    ```bash
    sdk list java
    ```

   ê·¸ëŸ° ë‹¤ìŒ ì›í•˜ëŠ” ë²„ì „ì„ ì„ íƒí•˜ì—¬ ì„¤ì¹˜

    ```bash
    sdk install java 17.0.8-oracle
    ```


1. ìë°” ë²„ì „ ì ìš©
  - ì „ì—­ ì„¤ì •

      ```bash
      sdk default java 17.0.8-oracle
      ```

  - ì‰˜ ì„¤ì • (ì‰˜ ë‚˜ê°€ë©´ ë²„ì „ í•´ì œ)

      ```bash
      sdk use java 17.0.8-oracle
      ```

  - í”„ë¡œì íŠ¸ë³„ ì„¤ì • (í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— .sdkmanrc íŒŒì¼)

      ```bash
      echo "java=17.0.8-oracle" > .sdkmanrc
      ```


ìë°”ë²„ì „ì´ ì •ìƒì ìœ¼ë¡œ ìë°”17 ë¡œ ë³€ê²½ë¨

![Untitled](ceos_5ì£¼ì°¨_img/Untitled%203.png)

ë¹Œë“œë„ ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰

![Untitled](ceos_5ì£¼ì°¨_img/Untitled%204.png)

## 2. web ì»¨í…Œì´ë„ˆê°€ db ì»¨í…Œì´ë„ˆì— ëª» ë¶™ëŠ” ì´ìŠˆ

```yaml
version: "3.7"
services:
  db:
    image: mysql
    container_name: spring-daangn-db
    env_file:
      - .env.dev
    ports:
      - "3307:3306"
    volumes:
      - ./dockerDB:/app
    restart: always
  web:
    container_name: spring-daangn-server
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    depends_on:
      - db
    restart: always
```

depends_on ì„ ë¶™í˜”ë‹¤ê³  í•´ì„œ db ê°€ ì™„ì „íˆ ë„ì›Œì§„ ë‹¤ìŒì— web ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ëŠ”ê²Œ ì•„ë‹ˆë¼

ê·¸ëƒ¥ ì‹¤í–‰ìˆœì„œë§Œ ì§€ì •í•´ì£¼ëŠ” ì—­í• ì´ë¼ì„œ web ì»¨í…Œì´ë„ˆì— `restart: always` ë¥¼ ë¶™í˜€ì•¼ í•¨

## 3. application profile ì„ ëª» ì½ëŠ” ì´ìŠˆ

springboot 2.4 ì´í›„ë¡œ profile ì§€ì • ë°©ë²•ì´ ë‹¬ë¼ì¡Œë‹¤ê³  í•¨

`application-local.yml`

```yaml
spring:
  profiles: # ì—ëŸ¬ë°œìƒ
    active: local # ì—ëŸ¬ë°œìƒ
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://host.docker.internal:3306/ceos_18?serverTimezone=Asia/Seoul
    username: root
    password: <password>

  jpa:
    hibernate:
      ddl-auto: create
    properties:
      hibernate:
        default_batch_fetch_size: 100
    open-in-view: false
```

ê¸°ì¡´ì—ëŠ” yaml íŒŒì¼ ì•ˆì—ì„œ spring:profile:active ì—ì„œ ì›í•˜ëŠ” profile ëª…ì„ ì¨ì¤¬ì–´ì•¼ í•˜ëŠ”ë°

springboot 2.4 ì´í›„ë¡œëŠ” ì´ë ‡ê²Œ í•˜ë©´ ì—ëŸ¬ê°€ ë°œìƒí•¨

profile:active ë¶€ë¶„ì„ ì§€ìš°ê³  application-{profile}.yml ë¡œ íŒŒì¼ì´ë¦„ë§Œ ì§€ì •í•˜ë©´ ì›í•˜ëŠ” profile ì„ ì˜ ì½ì–´ì˜´

> ì°¸ê³ 
>

spring ì—ì„œ application profile ì„ ì½ëŠ” ìˆœì„œ

â‡’ ê¸°ë³¸ application.yml ì„ ë¨¼ì € ì½ê³  ì§€ì •í•œ application-{profile}.yml ì„ ê·¸ ìœ„ì— ë®ì–´ ì”Œìš°ëŠ” ë°©ì‹ìœ¼ë¡œ ì‹¤í–‰ (override ë°©ì‹)

# ceos ìŠ¤í”„ë§ 6ì£¼ì°¨ ë¯¸ì…˜

# 1ï¸âƒ£Â ë„ì»¤ ì´ë¯¸ì§€ ë°°í¬í•˜ê¸°

### 1) EC2, RDS ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

### 2) spring project ì—ì„œ RDS ì¸ìŠ¤í„´ìŠ¤ ì—°ê²° ì„¤ì •

`appication-prod.yml`

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://<RDS ì—”ë“œí¬ì¸íŠ¸>:3306/daangn?serverTimezone=Asia/Seoul
    username: admin
    password: <RDS ë¹„ë°€ë²ˆí˜¸>
```

`docker-compose-prod.yml`

```yaml
version: "3.7"
services:
  web:
    platform: linux/amd64 # í”Œë«í¼ ì„¤ì •
    image: soul4927/ceos-spring:latest
    container_name: spring-daangn-server
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "80:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
```

- m1 mac ë¶€í„° arm cpu ë¼ì„œ ubuntu ì—ì„œ ë°°í¬í•  ë•ŒëŠ” í”Œë«í¼ì„ amd64 ë¡œ ì„¤ì •í•´ì¤˜ì•¼ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•ŠìŒ

jar ë¹Œë“œ í›„, ë¡œì»¬ì—ì„œ ë„ì»¤ ì»¨í…Œì´ë„ˆê°€ ì˜ ì˜¬ë¼ê°€ëŠ”ì§€ í…ŒìŠ¤íŠ¸

`./gradlew clean build`

`docker-compose -f docker-compose-prod.yml up â€”-build`

### 3) docker hub ì‚¬ìš©í•´ì„œ EC2 ì— ìˆ˜ë™ë°°í¬

- ë¡œì»¬ì—ì„œ image ë¹Œë“œ

  `docker-compose -f docker-compose-prod.yml build`


- docker image í™•ì¸

  `docker images`

  ![Untitled](ceos_6ì£¼ì°¨_img/Untitled.png)

- docker í—ˆë¸Œì— push

  `docker push <imageëª…:tagëª…>`

  (default tag : latest )

  ![Untitled](ceos_6ì£¼ì°¨_img/Untitled%201.png)


docker hub repository ì— image push ë¨

![Untitled](ceos_6ì£¼ì°¨_img/Untitled%202.png)

- ec2 ì ‘ì†


    - docker engine ì„¤ì¹˜ : [https://docs.docker.com/engine/install/ubuntu/#installation-methods](https://docs.docker.com/engine/install/ubuntu/#installation-methods)
    - docker-compose-prod.yml ì‘ì„±
    - docker image pull
        
        `docker pull <repoëª…/imageëª…:tagëª…>`
        
        ![Untitled](ceos_6ì£¼ì°¨_img/Untitled%203.png)
        
    
    - docker image run
        
        `sudo docker-compose -f docker-compose-prod.yml up`
        
        ![Untitled](ceos_6ì£¼ì°¨_img/Untitled%204.png)
        
    - http ë°°í¬ëŠ” ì™„ë£Œ
        
        ![Untitled](ceos_6ì£¼ì°¨_img/Untitled%205.png)


### ë¶€ì¡±í•œ ì 

- github aciton ë°°í¬í•˜ë ¤ë‹¤ê°€ ë§‰í˜€ì„œ ì¼ë‹¨ ìˆ˜ë™ìœ¼ë¡œ ë°°í¬..

  ![Untitled](ceos_6ì£¼ì°¨_img/Untitled%206.png)


- https ì¸ì¦ ê´€ë ¨

  route 53 ì´ ì•„ë‹Œ ë‹¤ë¥¸ ë„ë©”ì¸ ì—…ì²´ì—ì„œ ì‚° ë„ë©”ì¸ì´ë©´ aws ì—ì„œ í•˜ëŠ” ì„¤ì • ì™¸ì— ë¶€ê°€ì ì¸ ì‘ì—…ì´ ë” í•„ìš”í•˜ë”ë¼êµ¬ìš”

  í•´ë‹¹ ë¶€ë¶„ ë” ì°¾ì•„ì„œ https ì ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤